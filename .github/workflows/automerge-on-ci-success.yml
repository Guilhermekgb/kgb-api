name: Auto-merge on CI success (label-controlled)

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed

jobs:
  automerge:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Auto-merge PRs from this workflow run if labeled 'automerge'
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prs = github.context.payload.workflow_run.pull_requests || [];
            if (!prs.length) {
              console.log('No PRs associated with this workflow run.');
            }
            for (const pr of prs) {
              const { number, labels, state } = pr;
              if (state !== 'open') {
                console.log(`PR #${number} is not open, skipping.`);
                continue;
              }
              // Fetch labels via API to ensure up-to-date
              const { data: fullPr } = await github.pulls.get({ owner: context.repo.owner, repo: context.repo.repo, pull_number: number });
              const hasLabel = (fullPr.labels || []).some(l => String(l.name || '').toLowerCase() === 'automerge');
              if (!hasLabel) {
                console.log(`PR #${number} does not have label 'automerge', skipping.`);
                continue;
              }
              // Attempt merge
              try {
                await github.pulls.merge({ owner: context.repo.owner, repo: context.repo.repo, pull_number: number, merge_method: 'squash' });
                console.log(`Merged PR #${number} via automerge.`);
              } catch (err) {
                console.log(`Failed to merge PR #${number}: ${err.message}`);
              }
            }
