<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Escala do Evento</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- META de permiss√£o da p√°gina (importante para o guard por p√°gina) -->
  <meta name="page-permission" content="page:escala-evento.html">
  <!-- === IN√çCIO PATCH __API_BASE__ (auto) === -->
<script>
  (function(){
    var host = String(location.hostname||"").toLowerCase();

    // Produ√ß√£o (Netlify) -> API na Render
    var PROD_API = "https://kgb-api.onrender.com";

    // Desenvolvimento local
    var DEV_API  = "http://127.0.0.1:3333";

    var base = (/\.netlify\.app$/.test(host)) ? PROD_API
             : (host === "localhost" || host === "127.0.0.1") ? DEV_API
             : PROD_API;

    try { localStorage.setItem("API_BASE", base); } catch(e) {}
    window.__API_BASE__ = base;
    console.log("[KGB] __API_BASE__ =", base);
  })();
</script>
<!-- === FIM PATCH __API_BASE__ (auto) === -->


  <!-- Gate + helper de usu√°rio (carrega cedo para evitar "piscar") -->
  <script>
    // Disponibiliza globalmente ANTES do gate (sync helper)
    (function(){
        if (!window.getUsuarioAtual) {
          window.getUsuarioAtual = function(){
            let t = null;
            try { t = (window.obterUsuarioDoToken && window.obterUsuarioDoToken()) || null; } catch {}
            let uStore = null; try { uStore = JSON.parse(localStorage.getItem('usuarioAtual') || 'null'); } catch {}
            let legacy = window.__KGB_USER_CACHE || null;
            // trigger async population
            try { if (typeof window.getUsuarioAtualAsync === 'function') window.getUsuarioAtualAsync().then(u=>{ if(u) window.__KGB_USER_CACHE = u; }); } catch {}
            return t || uStore || legacy || null;
          };
        }
      })();

    // === Gate por evento designado (Admin sempre passa)
    (function(){
      const n   = s => String(s||"").normalize("NFD").replace(/\p{Diacritic}/gu,"").toLowerCase().trim();
      const get = (k,def="null")=>{ try{return JSON.parse(localStorage.getItem(k)||def);}catch{return null}; };

      // Encapsula checagem de permiss√£o em async init para poder usar sess√£o via cookie
      (async function(){
        const usuario = (typeof window.getUsuarioAtualAsync === 'function') ? (await window.getUsuarioAtualAsync()) : window.getUsuarioAtual();
        const isAdmin  = u => n(u?.perfil) === "administrador";
        const isMaitre = u => ["maitre","ma√Ætre"].includes(n(u?.perfil));
        const isResp   = u => ["responsavel por evento","respons√°vel por evento"].includes(n(u?.perfil));

        // ID do evento pela URL
        const urlId = new URLSearchParams(location.search).get("id");
        if (!urlId) { // sem id -> bloqueia para n√£o-admin
          if (!isAdmin(usuario)) {
            location.replace("acesso-negado.html?from=" + encodeURIComponent(location.pathname + location.search));
          }
          return;
        }

        const eventos = get("eventos","[]") || [];
        const ev = eventos.find(e => String(e.id) === String(urlId));

        // Evento n√£o existe ‚Üí s√≥ admin pode entrar
        if (!ev) {
          if (!isAdmin(usuario)) {
            location.replace("acesso-negado.html?from=" + encodeURIComponent(location.pathname + location.search));
          }
          return;
        }

        // Admin sempre ok
        if (isAdmin(usuario)) return;

        // Ma√Ætre / Respons√°vel ‚Üí precisa estar designado
        const souRespPeloNome = n(ev.responsavelEquipe) === n(usuario?.nome);

        const equipe = Array.isArray(ev.equipe) ? ev.equipe : [];
        const estouNaEquipe = equipe.some(p => n(p?.nome) === n(usuario?.nome));
        const funcaoDoUsuario = (equipe.find(p => n(p?.nome) === n(usuario?.nome))?.funcao || "").toLowerCase();

        const funcaoEhMaitre = ["maitre","ma√Ætre"].includes(n(funcaoDoUsuario));
        const funcaoEhResp   = n(funcaoDoUsuario).includes("responsavel");

       // NOVO: pode VER se for Admin, Respons√°vel, Ma√Ætre, ou estiver NA EQUIPE
        const podeVer =
          isAdmin(usuario) ||
          souRespPeloNome ||
          isMaitre(usuario) || isResp(usuario) ||
          estouNaEquipe;

        if (!podeVer) {
          location.replace("acesso-negado.html?from=" + encodeURIComponent(location.pathname + location.search));
        }
      })();
    })();
  </script>

  <script src="https://unpkg.com/lucide@latest"></script>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="menu-lateral.css" />
  <style>
    html,body{margin:0;padding:0;background:#f8f1e8;font-family:'Playfair Display',serif}
    .wrapper{display:flex;min-height:100vh;overflow:hidden}
    #menuLateral{flex-shrink:0;background:#5a3e2b;height:100vh;overflow-y:auto}
    main{flex:1;padding:40px;height:100vh;overflow-y:auto}
    .conteudo-central{max-width:1000px;margin:0 auto}
    @media(min-width:769px){#menuLateral{position:fixed;left:0;top:0;width:260px} main{margin-left:260px}}

    table.tabela{width:100%;border-collapse:collapse;background:#fff;border-radius:10px;overflow:hidden}
    .tabela th,.tabela td{padding:10px 12px;border-bottom:1px solid #eee;text-align:left}
    .tabela th{background:#f3e8da;color:#5a3e2b;font-weight:600}
    .tabela tr:last-child td{border-bottom:none}
    .muted{color:#6b7280}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}

    .bloco-detalhes{background:#fff;border-radius:14px;padding:22px;box-shadow:0 8px 20px rgba(0,0,0,.05);border:1px solid #efe3d6}
    .btn{background:#5a3e2b;color:#fff;border:0;padding:10px 16px;border-radius:10px;display:inline-flex;gap:8px;align-items:center;
         box-shadow:0 4px 10px rgba(0,0,0,.12);transition:transform .15s ease, box-shadow .15s ease, background .15s ease}
    .btn:hover{transform:translateY(-1px);box-shadow:0 8px 18px rgba(0,0,0,.16);background:#4c3426}
    .btn-ghost{background:#fff;border:1px solid #efe3d6;color:#4b3a2d;padding:8px 12px;border-radius:10px;display:inline-flex;gap:8px;align-items:center;cursor:pointer}
    .input-editar-cliente{border:1px solid #eadbcc;border-radius:10px;background:#fffdf9}
    .tag-resp{margin:10px 0 4px; padding:8px 12px; border:1px solid #eadbcc; border-radius:999px; background:#fff;
              display:inline-flex; align-items:center; gap:8px; color:#4b3a2d; font-weight:600}
    #contadorEquipe{background:#f4e9db;padding:4px 10px;border-radius:999px}
        /* === HAMB√öRGUER / MOBILE === */
    #hamburguer{
      position: fixed;
      top: 12px;
      left: 12px;
      z-index: 1001;
      background: #c29a5d;
      color: #fff;
      border: none;
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 22px;
      display: none;
      box-shadow: 0 4px 12px rgba(0,0,0,.18);
      cursor: pointer;
    }

    #hamburguer i{
      width: 20px;
      height: 20px;
    }

    @media (max-width: 768px){
      #hamburguer{
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }

      .wrapper{
        padding-left: 0;
      }

      #menuLateral{
        position: fixed;
        top: 0;
        left: 0;
        bottom: 0;
        width: 260px;
        max-width: 80vw;
        transform: translateX(-100%);
        transition: transform .25s ease;
        z-index: 999;
        background: #111827; /* mesma base do menu */
      }

      #menuLateral.aberto{
        transform: translateX(0);
      }

      main.conteudo-principal{
        padding: 20px 16px 32px;
      }
    }
/* Backdrop do menu (mobile) */
#menuBackdrop{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.38);
  z-index: 998;
}

/* trava o scroll quando o menu estiver aberto */
body.no-scroll{ overflow: hidden; }

  </style>
</head>
<body>
  <button id="hamburguer" aria-label="Abrir menu">
    <i data-lucide="menu"></i>
  </button>

  <div class="wrapper">
  <aside id="menuLateral"></aside>
<div id="menuBackdrop" hidden></div>
<main class="conteudo-principal">

  <div class="conteudo-central">

        <h1 style="color:#5a3e2b;display:flex;gap:10px;align-items:center"><i data-lucide="users"></i> Escala do Evento</h1>

        <div id="resumoResponsavel" class="tag-resp" style="display:none">
          <i data-lucide="shield-check"></i>
          <span>RESPONS√ÅVEL PELA EQUIPE ‚Äî </span>
          <strong id="nomeRespResumo"></strong>
        </div>

        <div id="bloqueio" class="bloco-detalhes" style="display:none"></div>

        <div id="wrapTudo">
          <div class="bloco-detalhes">
            <p><strong>Nome do Evento:</strong> <span id="nomeEvento">Carregando...</span></p>
            <p><strong>Data:</strong> <span id="dataEvento">‚Äî</span></p>
            <p><strong>Hor√°rio da cerim√¥nia:</strong> <span id="horaCerimonia">‚Äî</span></p>
          </div>

          <!-- Atribuir respons√°vel (Admin-only) -->
          <div class="bloco-detalhes" id="blocoResp">
            <h3 style="color:#5a3e2b;">Respons√°vel pela Equipe</h3>
            <div class="row">
              <select id="responsavelEquipeSelect" class="input-editar-cliente" style="min-width:280px"></select>
              <button class="btn" id="btnSalvarResp"><i data-lucide="save"></i> Salvar</button>
              <span id="hintPermissao" class="muted" style="display:none">Somente o administrador pode alterar.</span>
            </div>
            <small class="muted">Alter√°vel somente por Administrador.</small>
          </div>

          <!-- Equipe (somente leitura aqui) -->
          <div class="bloco-detalhes">
            <div class="row" style="justify-content:space-between">
              <h3 style="color:#5a3e2b;margin:0">üë• Equipe Escalada</h3>
              <span class="muted" id="contadorEquipe">0 pessoas</span>
            </div>
            <div id="wrapTabela"></div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script type="module" src="menu-lateral.js"></script>
<script>
  // ‚úÖ MENU HAMBURGUER (ABRE/FECHA) + BACKDROP + TRAVA SCROLL
  (function initMenuMobile(){
    const btn   = document.getElementById('hamburguer');
    const aside = document.getElementById('menuLateral');
    const back  = document.getElementById('menuBackdrop');

    if (!btn || !aside || !back) return;

    function abrir(){
      aside.classList.add('aberto');
      back.hidden = false;
      document.body.classList.add('no-scroll');
      btn.setAttribute('aria-expanded','true');
    }

    function fechar(){
      aside.classList.remove('aberto');
      back.hidden = true;
      document.body.classList.remove('no-scroll');
      btn.setAttribute('aria-expanded','false');
    }

    // clique no hamb√∫rguer: alterna abre/fecha
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      if (aside.classList.contains('aberto')) fechar();
      else abrir();
    });

    // clique no backdrop: fecha
    back.addEventListener('click', fechar);

    // clique fora do menu: fecha
    document.addEventListener('click', (e) => {
      if (!aside.classList.contains('aberto')) return;
      if (!aside.contains(e.target) && !btn.contains(e.target)) fechar();
    });

    // se voltar pro desktop: fecha
    window.addEventListener('resize', () => {
      if (window.innerWidth > 768) fechar();
    });
  })();

  document.addEventListener("DOMContentLoaded",()=>{ if(window.lucide) lucide.createIcons(); });

  const S_EVT="eventos", S_USR="usuarios", S_NOTIF="notificacoes";
  const q = (s)=>document.querySelector(s);
  const norm = (s)=>String(s||"").normalize("NFD").replace(/\p{Diacritic}/gu,"").toLowerCase().trim();
  const get = (k,def="[]") => { try{return JSON.parse(localStorage.getItem(k)||def);}catch{return JSON.parse(def);} };
  const set = (k,v) => localStorage.setItem(k, JSON.stringify(v));

  // Helpers para JSON no localStorage (cache leve)
  const getJSON = (k, fb)=>{ 
    try{ 
      const v = JSON.parse(localStorage.getItem(k)||'null'); 
      return v ?? fb; 
    }catch{ 
      return fb; 
    } 
  };
  const setJSON = (k, v)=>{ 
    try{ 
      localStorage.setItem(k, JSON.stringify(v)); 
    }catch{} 
  };

  // Carrega o evento pela API, com cache em localStorage como fallback
  async function carregarEventoDoBackend(evtId) {
    if (!evtId) return null;

    if (typeof IS_REMOTE === "undefined" || !IS_REMOTE) {
      const lista = getJSON(S_EVT, []);
      return (lista || []).find(e => String(e.id) === String(evtId)) || null;
    }

    try {
      const resp = await callApi(`/eventos/${encodeURIComponent(String(evtId))}`, "GET", {});
      const ev = resp?.data || resp;

      if (ev && ev.id) {
        // atualiza cache local "eventos"
        try {
          const lista = getJSON(S_EVT, []);
          const i = lista.findIndex(e => String(e.id) === String(ev.id));
          if (i > -1) lista[i] = ev; else lista.push(ev);
          setJSON(S_EVT, lista);
        } catch {}
      }

      return ev || null;
    } catch (e) {
      console.warn("[escala-evento] Falha ao carregar evento da API, usando cache local", e);
      const lista = getJSON(S_EVT, []);
      return (lista || []).find(e => String(e.id) === String(evtId)) || null;
    }
  }

  // Use o helper global definido no <head>
  const getUser = window.getUsuarioAtual;
  const isAdmin = (u)=> norm(u?.perfil)==="administrador";

  const urlId = new URLSearchParams(location.search).get("id");
  let id = urlId && urlId !== "EVENTOID" ? String(urlId) : "";
  if(!id){
    const sel = localStorage.getItem("eventoSelecionado");
    if(sel){ try{ const maybe = JSON.parse(sel); id = maybe?.id ? String(maybe.id) : String(sel); } catch{ id = String(sel); } }
  }

  // helpers de telefone/mensagem
  const onlyDigits = s => String(s||"").replace(/\D/g,"");
  const brPhone    = p => {
    const d = onlyDigits(p);
    if (d.startsWith("55") && d.length === 13) return d;        // 55 + 11 d√≠gitos
    if (d.length === 11) return "55" + d;                        // celular BR
    return d;
  };

  function findWhatsappByName(nome){
    const norm = s => String(s||"").normalize("NFD").replace(/\p{Diacritic}/gu,"").toLowerCase().trim();
    const alvo = norm(nome);
    const usuarios = (()=>{ try{ return JSON.parse(localStorage.getItem("usuarios")||"[]"); }catch{ return []; } })();
    const colabs   = (()=>{ try{ return JSON.parse(localStorage.getItem("colaboradoresBase")||"[]"); }catch{ return []; } })();

    let u = usuarios.find(x => norm(x.nome) === alvo && x.whatsapp);
    if (u && u.whatsapp) return u.whatsapp;
    let c = colabs.find(x => norm(x.nome) === alvo && x.whatsapp);
    return c ? c.whatsapp : "";
  }

  function buildMsgResponsavel(ev, responsavel){
    const pick = (obj, keys)=>{ for(const k of keys){ if(obj && obj[k]!=null && String(obj[k]).trim()!=="") return obj[k]; } return ""; };
    const nome = pick(ev, ["nomeEvento","titulo","nome"]) || "Evento";
    const data = (()=> {
      const raw = pick(ev, ["data","dataEvento","dataDoEvento"]);
      const v = String(raw||"").trim();
      if (/^\d{4}-\d{2}-\d{2}$/.test(v)) { const [y,m,d]=v.split("-"); return `${d}/${m}/${y}`; }
      return v || "‚Äî";
    })();
    const qtd  = Number(pick(ev, ["convidados","qtdConvidados","quantidadeConvidados"])) || 0;

    return [
      `Ol√° ${responsavel}!`,
      `Voc√™ foi escalado(a) como *RESPONS√ÅVEL* pelo evento:`,
      `‚Ä¢ Evento: ${nome}`,
      `‚Ä¢ Data: ${data}`,
      `‚Ä¢ Convidados: ${qtd}`,
      ``,
      `Qualquer ajuste na escala pode ser feito pela p√°gina do evento.`,
    ].join("\n");
  }

  function abrirDialogWhats(responsavel, telefone, mensagem){
    const dlg = document.getElementById("dlgWhatsResp");
    const pre = document.getElementById("dlgWhatsMsg");
    const a   = document.getElementById("btnOpenWa");
    const copyBtn = document.getElementById("btnCopyMsg");

    pre.textContent = mensagem;

    const waNum = brPhone(telefone||"");
    const url = waNum
      ? `https://wa.me/${waNum}?text=${encodeURIComponent(mensagem)}`
      : `https://wa.me/?text=${encodeURIComponent(mensagem)}`;
    a.href = url;

    copyBtn.onclick = async ()=> {
      try { await navigator.clipboard.writeText(mensagem); copyBtn.textContent = "Copiado!"; setTimeout(()=>copyBtn.textContent="Copiar mensagem", 1500); }
      catch{ }
    };

    if (typeof dlg.showModal === "function") dlg.showModal(); else dlg.setAttribute("open","");
  }

  function pick(ev, keys){ for(const k of keys){ if(ev && ev[k] != null && String(ev[k]).trim() !== "") return ev[k]; } return ""; }
  function fmtData(s){
    const v = String(s||"").trim();
    if(/^\d{4}-\d{2}-\d{2}$/.test(v)){ const [y,m,d]=v.split("-"); return `${d}/${m}/${y}`; }
    return v || "‚Äî";
  }

  let usuario = null;
  let eventoSelecionado = null;

  function renderResumoResponsavel(){
    const box  = document.getElementById("resumoResponsavel");
    const span = document.getElementById("nomeRespResumo");
    const n = (eventoSelecionado?.responsavelEquipe || "").trim();
    if(n){ span.textContent = n; box.style.display = "inline-flex"; }
    else { box.style.display = "none"; }
  }

  function bloquear(msg){
    q("#bloqueio").style.display="block";
    q("#wrapTudo").style.display="none";
    q("#bloqueio").innerHTML = `<p>${msg}</p>`;
  }

  document.addEventListener("DOMContentLoaded", async ()=>{
    usuario = getUser(); // helper global

    // Carrega o evento pela API (com cache local como plano B)
    eventoSelecionado = await carregarEventoDoBackend(id);

    if(!eventoSelecionado){ bloquear("Evento n√£o encontrado."); return; }
    if(norm(eventoSelecionado.status)==="arquivado"){ bloquear("Este evento foi arquivado/exclu√≠do."); return; }

    renderResumoResponsavel();
    renderTabela();
    popularUsuariosNoSelect();
  });

  function popularUsuariosNoSelect(){
    const sel = q("#responsavelEquipeSelect");
    const users = get(S_USR,"[]");
    const opcoes = users
      .filter(u => ["maitre","ma√Ætre","administrador"].includes(norm(u.perfil)))
      .sort((a,b)=>norm(a.nome).localeCompare(norm(b.nome)));
    sel.innerHTML = "";
    sel.appendChild(new Option("Selecione...",""));
    if(opcoes.length){ opcoes.forEach(u=> sel.appendChild(new Option(u.nome, u.nome))); }
    if(eventoSelecionado?.responsavelEquipe){ sel.value = eventoSelecionado.responsavelEquipe; }
  }

  function salvarResponsavel(){
    if(!isAdmin(usuario)) return;

    const novo = q("#responsavelEquipeSelect").value.trim();
    eventoSelecionado.responsavelEquipe = novo || "";
    persistEvento(eventoSelecionado);
    renderResumoResponsavel();

    if(novo){
      const arr = get(S_NOTIF);
      arr.push({
        id: "ntf_"+Math.random().toString(36).slice(2,10),
        paraNome: novo,
        titulo: "Novo evento sob sua responsabilidade",
        msg: `Voc√™ agora √© o respons√°vel pela equipe do evento: ${(eventoSelecionado.nomeEvento||"Evento")}.`,
        link: location.href,
        lida: false,
        criadoEm: new Date().toISOString()
      });
      set(S_NOTIF, arr);
    }

    try {
      if (window.__agendaBridge && typeof window.__agendaBridge.upsertUnifiedItem === "function") {
        const usuarios = get(S_USR, "[]") || [];
        const normName = s => String(s||"").normalize("NFD").replace(/\p{Diacritic}/gu,"").toLowerCase().trim();
        const userFull = usuarios.find(u => normName(u.nome) === normName(novo)) || null;

        const audience = String(userFull?.email || userFull?.nome || novo || "").toLowerCase();

        const nomeEv = pick(eventoSelecionado, ["nomeEvento","titulo","nome"]) || "Evento";
        const dataEv = pick(eventoSelecionado, ["data","dataEvento","dataDoEvento"]) || "";

        window.__agendaBridge.upsertUnifiedItem({
          id:       `evt:${eventoSelecionado.id}:resp`,
          src:      "evento",
          title:    `Respons√°vel por: ${nomeEv}`,
          date:     dataEv,
          status:   "scheduled",
          audience: audience,
          entity:   { type: "evento", id: eventoSelecionado.id }
        });

        if (typeof window.__agendaBridge.publishNotificationFeed === "function" && audience) {
          window.__agendaBridge.publishNotificationFeed({
            unifiedId: `evt:${eventoSelecionado.id}:resp`,
            title: `Novo evento sob sua responsabilidade: ${nomeEv}`,
            level: "info",
            audience: audience,
            createdAtISO: new Date().toISOString(),
            kind: "evento-responsavel"
          });
        }
      }
    } catch(e){
      console.warn("Falha ao integrar com agendaUnified/notificationsFeed:", e);
    }

    if(novo){
      const tel = findWhatsappByName(novo);
      const msg = buildMsgResponsavel(eventoSelecionado, novo);
      abrirDialogWhats(novo, tel, msg);
    } else {
      alert("Respons√°vel removido.");
    }
  }

  function renderTabela(){
    const wrap = q("#wrapTabela");
    const equipe = Array.isArray(eventoSelecionado?.equipe) ? eventoSelecionado.equipe : [];
    if(!equipe.length){
      wrap.innerHTML = `<div class="muted">Nenhum colaborador na escala.</div>`;
      q("#contadorEquipe").textContent = "0 pessoas";
      return;
    }
    const digits = (s)=>String(s||"").replace(/\D/g,"");
    const brPhone = (p)=>{ const d=digits(p); if(d.startsWith("55")&&d.length===13) return d; if(d.length===11) return "55"+d; return d; };

    const rows = equipe.map(p=>{
      const wa = p.whatsapp ? `<a href="https://wa.me/${brPhone(p.whatsapp)}" target="_blank" rel="noopener">${p.whatsapp}</a>` : "‚Äî";
      return `
        <tr>
          <td>${p.funcao||"‚Äî"}</td>
          <td>${p.nome||"‚Äî"}</td>
          <td>${wa}</td>
          <td>${p.hora||"‚Äî"}</td>
          <td>${p.obs||"‚Äî"}</td>
        </tr>`;
    }).join("");
    wrap.innerHTML = `
      <div class="tabela" style="border:1px solid #efe3d6;border-radius:10px;overflow:hidden">
        <table class="tabela">
          <thead>
            <tr>
              <th>Fun√ß√£o</th>
              <th>Nome</th>
              <th>WhatsApp</th>
              <th>Hor√°rio</th>
              <th>Observa√ß√£o</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      </div>`;
    q("#contadorEquipe").textContent = equipe.length + (equipe.length===1?" pessoa":" pessoas");
  }

  async function persistEvento(ev){
    const all = getJSON(S_EVT, []);
    const i = all.findIndex(e => String(e.id)===String(ev.id));
    if(i>=0){ all[i]=ev; } else { all.push(ev); }
    setJSON(S_EVT, all);

    window.dispatchEvent(new StorageEvent("storage",{ key:S_EVT, newValue:JSON.stringify(all) }));

    if (typeof IS_REMOTE !== "undefined" && IS_REMOTE && typeof callApi === "function") {
      try {
        await callApi(`/eventos/${encodeURIComponent(String(ev.id))}`, "PUT", ev);
      } catch(e){
        console.warn("[escala-evento] Falha ao salvar equipe/escala na API", e);
      }
    }
  }

  window.addEventListener("storage",(e)=>{
    if(e.key===S_EVT){
      const evts2 = JSON.parse(e.newValue||"[]");
      const novo  = evts2.find(x=> String(x.id)===String(id));
      if(novo){
        const mudouResp = norm(novo.responsavelEquipe) !== norm(eventoSelecionado?.responsavelEquipe);
        eventoSelecionado = novo;
        renderResumoResponsavel();
        renderTabela();
        if(mudouResp) popularUsuariosNoSelect();
      }
    }
  });
</script>


  <!-- Dialog: enviar WhatsApp para o Respons√°vel -->
  <dialog id="dlgWhatsResp" style="border:0; border-radius:14px; padding:0; max-width:520px; width:96%">
    <form method="dialog" style="margin:0; background:#fff; border:1px solid #eadfd2; border-radius:14px; overflow:hidden">
      <header style="display:flex; align-items:center; justify-content:space-between; gap:8px; padding:12px 14px; background:#fbf5ee; border-bottom:1px solid #eadfd2">
        <strong style="color:#5a3e2b; display:flex; gap:8px; align-items:center">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" style="opacity:.85" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 5a2 2 0 0 1 2-2h3.6a1 1 0 0 1 .8.4l1.8 2.4H19a2 2 0 0 1 2 2v1H3Z"/><path d="M3 7v10a2 2 0 0 0 2 2h14l2-8H3Z"/></svg>
          Enviar WhatsApp para o Respons√°vel
        </strong>
        <button value="cancel" style="background:#fff;border:1px solid #eadfd2;border-radius:10px;padding:6px 10px;cursor:pointer">Fechar</button>
      </header>

      <div style="padding:14px">
        <div id="dlgWhatsMsg" style="white-space:pre-wrap; background:#fffdf9; border:1px solid #eadfd2; border-radius:10px; padding:10px; color:#4b3a2d"></div>

        <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px">
          <button id="btnCopyMsg" type="button" style="background:#fff;border:1px solid #eadfd2;border-radius:10px;padding:8px 12px;cursor:pointer">Copiar mensagem</button>
          <a id="btnOpenWa" target="_blank" rel="noopener"
             style="background:#25D366;color:#fff;border:0;border-radius:10px;padding:10px 14px;text-decoration:none;display:inline-flex;align-items:center;gap:8px">
            Abrir WhatsApp
          </a>
        </div>
      </div>
    </form>
  </dialog>


  <script src="/js/auth-helper.js"></script>
  <script src="/api/api-fetch.js"></script>
  <script type="module" src="/api/proteger-pagina.js"></script>
</body>
</html>
