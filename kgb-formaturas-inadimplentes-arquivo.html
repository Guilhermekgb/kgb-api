<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KGB FORMATURAS - Inadimplentes e Arquivo</title>

  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <!-- Estilos globais do sistema -->
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="menu-lateral.css?v=espresso12">

  <style>
    :root{ --sidebar-w:260px; }

    html, body{
      margin:0; padding:0; background:#f8f1e8; height:100%;
    }

    main.conteudo-principal,
    input, select, textarea, button{
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
    }
    h1, h2, h3{
      font-family:"Playfair Display", ui-serif, Georgia, "Times New Roman", serif;
    }

    .wrapper{
      display:flex;
      min-height:100vh;
      overflow:hidden;
    }

    #menuLateral{
      flex-shrink:0;
      height:100vh;
      overflow-y:auto;
    }

    main.conteudo-principal{
      flex:1;
      min-height:100vh;
      height:auto;
      overflow-y:auto;
      width:100% !important;
      max-width:none !important;
      margin:0 !important;
      padding:24px clamp(16px, 3vw, 32px) 40px;
    }

    .conteudo-central{ display:contents !important; }

    h1{
      font-size:26px;
      color:#5a3e2b;
      display:flex;
      align-items:center;
      gap:10px;
      margin-bottom:4px;
    }
    h1 i{
      width:26px; height:26px;
      color:#c29a5d;
    }
    .subtitulo{
      margin:0 0 18px;
      font-size:14px;
      color:#8a6a4a;
    }

    #hamburguer{
      position:fixed; top:12px; left:12px;
      background:#c29a5d; border:none; color:#fff;
      font-size:24px; padding:6px 12px; border-radius:8px;
      z-index:1001; display:none;
      cursor:pointer;
    }

    @media (min-width:769px){
      #menuLateral{
        position:fixed; inset:0 auto 0 0;
        width:var(--sidebar-w); height:100vh; z-index:999;
      }
      .wrapper{ padding-left:var(--sidebar-w); }
      main.conteudo-principal{ margin-left:0 !important; }
    }

    @media (max-width:768px){
      #hamburguer{ display:block; }

      #menuLateral{
        position:fixed;
        transform:translateX(-100%);
        transition:transform .3s ease;
        z-index:999; width:var(--sidebar-w);
      }
      #menuLateral.aberto{ transform:translateX(0); }

      .wrapper{ padding-left:0; }
      main.conteudo-principal{ padding:20px; }
    }

    html body aside#menuLateral{
      background-color:#532b03 !important;
      background-image:none !important;
      box-shadow:2px 0 14px rgba(0,0,0,.18);
    }
    aside#menuLateral .menu-lateral,
    aside#menuLateral .submenu{
      background:transparent !important;
      background-color:transparent !important;
    }

    /* --------- TOPO / FILTROS --------- */

    .linha-topo-financeiro{
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      flex-wrap:wrap;
      gap:12px;
      margin-bottom:10px;
    }

    .grupo-filtros{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
    }

    .campo{
      display:flex;
      flex-direction:column;
      gap:4px;
      font-size:12px;
      color:#7a5a3c;
    }
    .campo label{
      font-weight:500;
    }
    .campo select,
    .campo input{
      padding:6px 10px;
      border-radius:8px;
      border:1px solid #e1cbb0;
      background:#fff;
      font-size:13px;
      outline:none;
      min-width:160px;
    }
    .campo select:focus,
    .campo input:focus{
      border-color:#c29a5d;
      box-shadow:0 0 0 1px rgba(194,154,93,0.25);
    }

    .btn-primario,
    .btn-secundario{
      border:none;
      border-radius:999px;
      padding:8px 16px;
      font-size:13px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      box-shadow:0 8px 16px rgba(0,0,0,.12);
    }
    .btn-primario{
      background:#c29a5d;
      color:#fff;
    }
    .btn-secundario{
      background:#f5e7d8;
      color:#6c4b30;
    }
    .btn-primario i,
    .btn-secundario i{
      width:16px; height:16px;
    }

    /* --------- ABAS --------- */

    .abas-financeiro{
      display:flex;
      gap:8px;
      margin:4px 0 14px;
      border-bottom:1px solid #f0dfcf;
    }
    .aba-botao{
      border:none;
      background:transparent;
      padding:6px 12px 8px;
      font-size:13px;
      cursor:pointer;
      color:#7a5a3c;
      border-radius:10px 10px 0 0;
    }
    .aba-botao.ativa{
      background:#fff;
      color:#4b2d16;
      box-shadow:0 -2px 6px rgba(0,0,0,.06);
      border-bottom:1px solid #fff;
      font-weight:600;
    }
    .aba-conteudo[hidden]{
      display:none;
    }

    /* --------- LAYOUT PRINCIPAL --------- */

    .grid-financeiro{
      display:grid;
      grid-template-columns:minmax(0, 1.6fr) minmax(0, 0.9fr);
      gap:18px;
      align-items:flex-start;
      margin-bottom:20px;
    }
    @media (max-width:1000px){
      .grid-financeiro{
        grid-template-columns:1fr;
      }
    }

    .card{
      background:#fff;
      border-radius:14px;
      padding:16px 18px;
      box-shadow:0 8px 20px rgba(0,0,0,.06);
    }
    .card h2{
      font-size:18px;
      margin:0 0 10px;
      color:#5a3e2b;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .card h2 i{
      width:18px; height:18px;
    }

    .texto-suporte{
      font-size:11px;
      color:#9a7b58;
      margin-top:4px;
    }

    /* --------- TABELA --------- */

    .tabela-simples{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }
    .tabela-simples thead{
      background:#f5e7d8;
    }
    .tabela-simples th,
    .tabela-simples td{
      padding:8px 10px;
      text-align:left;
      vertical-align:middle;
    }
    .tabela-simples th{
      font-weight:600;
      color:#6c4b30;
    }
    .tabela-simples tbody tr:nth-child(even){
      background:#fdf7f0;
    }

    .tag-evento{
      display:inline-flex;
      padding:3px 8px;
      border-radius:999px;
      font-size:11px;
      background:#f3e8da;
      color:#6c4b30;
      margin-right:4px;
      margin-bottom:2px;
    }

    .status-financeiro{
      font-size:11px;
      padding:3px 8px;
      border-radius:999px;
      display:inline-flex;
      align-items:center;
      gap:4px;
    }
    .status-financeiro i{
      width:12px; height:12px;
    }
    .status-atraso{
      background:#ffe8e5;
      color:#a32222;
    }
    .status-aberto{
      background:#fff8e2;
      color:#7a5a00;
    }
    .status-acordo{
      background:#e4f0ff;
      color:#244577;
    }
    .status-quitado{
      background:#e4f7ec;
      color:#1f6b3b;
    }

    .btn-acao-mini{
      border:none;
      border-radius:999px;
      padding:4px 10px;
      font-size:11px;
      cursor:pointer;
      background:#f5e7d8;
      color:#6c4b30;
      display:inline-flex;
      align-items:center;
      gap:4px;
    }
    .btn-acao-mini i{
      width:13px; height:13px;
    }

    .acoes-multiplas{
      display:flex;
      flex-wrap:wrap;
      gap:4px;
      justify-content:flex-end;
    }

    .rodape-tabela{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-top:10px;
      font-size:11px;
      color:#9a7b58;
      flex-wrap:wrap;
      gap:8px;
    }

    .resumo-valores{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:10px;
    }
    .card-resumo{
      background:#fdf7f0;
      border-radius:10px;
      padding:8px 12px;
      min-width:150px;
      font-size:12px;
      color:#7a5a3c;
    }
    .card-resumo strong{
      display:block;
      font-size:12px;
      color:#4b2d16;
      margin-bottom:2px;
    }

    /* --------- BLOCO ARQUIVO --------- */

    .card-arquivo{
      margin-bottom:16px;
    }

    .alerta-arquivo{
      font-size:11px;
      color:#7a5a00;
      background:#fff8e2;
      border-radius:10px;
      padding:8px 10px;
      margin-top:6px;
    }

    .linha-form-inline{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:flex-end;
      margin-top:6px;
      margin-bottom:6px;
    }

    .separador-sec{
      border:none;
      border-top:1px solid #f0dfcf;
      margin:14px 0;
    }
  </style>
</head>
<body>

  <!-- Botão Mobile -->
  <button id="hamburguer" aria-label="Abrir menu"><i data-lucide="menu"></i></button>

  <div class="wrapper">
    <aside id="menuLateral"></aside>
    <div id="menuBackdrop" hidden></div>

    <main class="conteudo-principal">
      <div class="conteudo-central">

        <h1><i data-lucide="wallet-cards"></i> Financeiro – Inadimplentes e Arquivo</h1>
        <p class="subtitulo">
          Veja todos os inadimplentes em um só lugar, arquive os anos concluídos e consulte depois os formandos já encerrados.
        </p>

        <!-- TOPO / FILTROS GERAIS -->
        <div class="linha-topo-financeiro">
          <div class="grupo-filtros">
            <div class="campo">
              <label for="filtroAno">Ano da formatura</label>
              <select id="filtroAno">
                <option value="">Todos</option>
              </select>
            </div>
            <div class="campo">
              <label for="filtroEscola">Escola</label>
              <select id="filtroEscola">
                <option value="">Todas</option>
              </select>
            </div>
            <div class="campo">
              <label for="filtroSituacao">Situação</label>
              <select id="filtroSituacao">
                <option value="">Todos</option>
                <option value="atraso">Em atraso</option>
                <option value="aberto">Em aberto</option>
                <option value="acordo">Em acordo</option>
              </select>
            </div>
          </div>

          <button type="button" class="btn-secundario" id="btnAtualizarLista">
            <i data-lucide="refresh-ccw"></i>
            Atualizar lista
          </button>
        </div>

        <!-- ABAS -->
        <div class="abas-financeiro">
          <button type="button" class="aba-botao ativa" data-aba="inadimplentes">Inadimplentes</button>
          <button type="button" class="aba-botao" data-aba="arquivados">Arquivados</button>
        </div>

        <!-- ABA INADIMPLENTES -->
        <div id="abaInadimplentes" class="aba-conteudo">
          <div class="grid-financeiro">

            <!-- COLUNA ESQUERDA: INADIMPLENTES -->
            <section class="card" aria-label="Lista de inadimplentes">
              <h2><i data-lucide="triangle-alert"></i> Inadimplentes por aluno</h2>

              <div class="texto-suporte">
                Aqui aparecem somente os alunos com algum valor em aberto ou em atraso. Alunos quitados não ficam nessa lista – podem ser arquivados por ano no painel ao lado.
              </div>

              <table class="tabela-simples" style="margin-top:10px;">
                <thead>
                  <tr>
                    <th>Aluno</th>
                    <th>Escola / Ano</th>
                    <th>Eventos contratados</th>
                    <th>Total</th>
                    <th>Pago</th>
                    <th>Em aberto</th>
                    <th>Situação</th>
                    <th>Último vencimento</th>
                    <th style="width:260px;">Ações</th>
                  </tr>
                </thead>
                <tbody id="tbodyInadimplentes">
                  <!-- preenchido via JS -->
                </tbody>
              </table>

              <div class="rodape-tabela">
                <span id="infoResumoInadimplentes">Exibindo 0 alunos inadimplentes.</span>
                <button type="button" class="btn-secundario" id="btnExportarInadimplentes">
                  <i data-lucide="download"></i>
                  Exportar lista (Excel)
                </button>
              </div>

              <div class="resumo-valores">
                <div class="card-resumo">
                  <strong>Total em aberto (filtro atual)</strong>
                  <span id="lblTotalAbertoInadimplentes">R$ 0,00</span>
                </div>
                <div class="card-resumo">
                  <strong>Nº de inadimplentes</strong>
                  <span id="lblQtdInadimplentes">0 alunos</span>
                </div>
              </div>
            </section>

            <!-- COLUNA DIREITA: ARQUIVO DE ANO -->
            <aside>

              <section class="card card-arquivo" aria-label="Arquivo de ano">
                <h2><i data-lucide="archive"></i> Arquivo de ano de formatura</h2>

                <p class="texto-suporte">
                  Use este painel para arquivar um ano já encerrado. Os alunos quitados serão movidos para o arquivo. Quem ainda estiver inadimplente continua aparecendo aqui em Inadimplentes.
                </p>

                <div class="linha-form-inline">
                  <div class="campo">
                    <label for="arquivoAno">Ano da formatura</label>
                    <select id="arquivoAno">
                      <!-- preenchido via JavaScript com anos reais -->
                    </select>
                  </div>

                  <button type="button" class="btn-secundario" id="btnCarregarResumoAno">
                    <i data-lucide="search"></i>
                    Ver resumo do ano
                  </button>
                </div>

                <div class="resumo-valores">
                  <div class="card-resumo">
                    <strong>Alunos cadastrados no ano</strong>
                    <span id="lblAnoTotalAlunos">0</span>
                  </div>
                  <div class="card-resumo">
                    <strong>Quitados</strong>
                    <span id="lblAnoQuitados">0</span>
                  </div>
                  <div class="card-resumo">
                    <strong>Inadimplentes</strong>
                    <span id="lblAnoInadimplentes">0</span>
                  </div>
                </div>

                <div class="alerta-arquivo">
                  <strong>Atenção:</strong> ao arquivar o ano:
                  <ul style="margin:4px 0 0 18px; padding:0;">
                    <li style="margin-bottom:2px;">Os <strong>alunos quitados</strong> não aparecerão mais nas listas normais de alunos.</li>
                    <li style="margin-bottom:2px;">Os <strong>inadimplentes continuam</strong> visíveis na lista de Inadimplentes até regularização.</li>
                    <li>Você poderá consultar os arquivados depois na aba "Arquivados".</li>
                  </ul>
                </div>

                <div class="linha-form-inline" style="margin-top:10px;">
                  <button type="button" class="btn-primario" id="btnArquivarAno">
                    <i data-lucide="archive"></i>
                    Arquivar ano (somente quitados)
                  </button>
                </div>
              </section>

              <section class="card" aria-label="Histórico de arquivamentos">
                <h2><i data-lucide="history"></i> Histórico de arquivamentos</h2>

                <table class="tabela-simples">
                  <thead>
                    <tr>
                      <th>Ano</th>
                      <th>Data</th>
                      <th>Quitados arquivados</th>
                      <th>Inadimplentes mantidos</th>
                    </tr>
                  </thead>
                  <tbody id="tbodyHistoricoArquivo">
                    <!-- preenchido via JS -->
                  </tbody>
                </table>

                <div class="texto-suporte" style="margin-top:8px;">
                  Esses registros são apenas para você lembrar quando cada ano foi arquivado e quantos alunos ficaram pendentes.
                </div>
              </section>

            </aside>

          </div>
        </div>

        <!-- ABA ARQUIVADOS -->
        <div id="abaArquivados" class="aba-conteudo" hidden>
          <section class="card" aria-label="Alunos arquivados">
            <h2><i data-lucide="archive-restore"></i> Alunos arquivados</h2>
            <p class="texto-suporte">
              Aqui você encontra os formandos que já quitaram tudo e foram arquivados por ano de formatura.
            </p>

            <table class="tabela-simples" style="margin-top:10px;">
              <thead>
                <tr>
                  <th>Aluno</th>
                  <th>Escola / Ano</th>
                  <th>Eventos contratados</th>
                  <th>Total pago</th>
                  <th>Data arquivamento</th>
                  <th style="width:160px;">Ações</th>
                </tr>
              </thead>
              <tbody id="tbodyArquivados">
                <!-- preenchido via JS -->
              </tbody>
            </table>

            <div class="rodape-tabela">
              <span id="infoResumoArquivados">Exibindo 0 alunos arquivados.</span>
            </div>
          </section>
        </div>

      </div>
    </main>
  </div>

  <script>
    window.firebaseSync = window.firebaseSync || {};
    window.firebaseSync.enabled = true;
  </script>

  <script type="module" src="menu-lateral.js"></script>

  <script type="module">
    import guard, { aplicarPermissoesNaTela } from './api/proteger-pagina.js';

    const meta = document.querySelector('meta[name="page-permission"]');
    const permissao = meta?.content?.trim();
    if (permissao) guard({ permissao });

    aplicarPermissoesNaTela();

    try {
      const alvo = document.getElementById('menuLateral');
      if (alvo) {
        const obs = new MutationObserver((muts, o) => {
          if (alvo.firstElementChild) {
            aplicarPermissoesNaTela();
            o.disconnect();
          }
        });
        obs.observe(alvo, { childList: true });
      }
    } catch {}
  </script>

  <script>
    // ------- CONSTANTES LOCALSTORAGE -------
    const LS_KEY_FINANCEIRO   = 'kgb_formaturas_financeiro_alunos';
    const LS_KEY_ARQUIVO      = 'kgb_formaturas_arquivo_alunos';
    const LS_KEY_HIST_ARQUIVO = 'kgb_formaturas_historico_arquivos';

    let financeiroAlunos = [];
    let arquivoAlunos    = [];
    let historicoArquivos = [];

    let listaInadimplentesFiltrada = [];
    let listaArquivadosFiltrada    = [];

    function criarId(prefixo){
      return (prefixo || 'id_') + Date.now() + '_' + Math.floor(Math.random() * 1e6);
    }

    function formatarValorBR(num){
      const n = Number(num) || 0;
      return n.toLocaleString('pt-BR', {
        minimumFractionDigits:2,
        maximumFractionDigits:2
      });
    }

    function formatarDataBR(iso){
      if (!iso) return '-';
      const d = new Date(iso);
      if (isNaN(d.getTime())) return '-';
      const dia = String(d.getDate()).padStart(2,'0');
      const mes = String(d.getMonth()+1).padStart(2,'0');
      const ano = d.getFullYear();
      return `${dia}/${mes}/${ano}`;
    }

    function formatarDataHoraBR(iso){
      if (!iso) return '-';
      const d = new Date(iso);
      if (isNaN(d.getTime())) return '-';
      const dia = String(d.getDate()).padStart(2,'0');
      const mes = String(d.getMonth()+1).padStart(2,'0');
      const ano = d.getFullYear();
      const hh  = String(d.getHours()).padStart(2,'0');
      const mm  = String(d.getMinutes()).padStart(2,'0');
      return `${dia}/${mes}/${ano} ${hh}:${mm}`;
    }

    // ------- CARREGAR / SALVAR DADOS -------

    function carregarFinanceiro(){
      try{
        const raw = localStorage.getItem(LS_KEY_FINANCEIRO);
        let arr = raw ? JSON.parse(raw) : [];
        if (!Array.isArray(arr)) arr = [];
        // sem seeds: usa só dados reais gravados pelo sistema
        return arr;
      }catch(e){
        console.error('Erro ao carregar financeiro', e);
        return [];
      }
    }

    function salvarFinanceiro(lista){
      try{
        localStorage.setItem(LS_KEY_FINANCEIRO, JSON.stringify(lista));
      }catch(e){
        console.error('Erro ao salvar financeiro', e);
      }
    }

    function carregarArquivo(){
      try{
        const raw = localStorage.getItem(LS_KEY_ARQUIVO);
        let arr = raw ? JSON.parse(raw) : [];
        if (!Array.isArray(arr)) arr = [];
        // sem seeds: somente arquivamentos reais
        return arr;
      }catch(e){
        console.error('Erro ao carregar arquivo', e);
        return [];
      }
    }

    function salvarArquivo(lista){
      try{
        localStorage.setItem(LS_KEY_ARQUIVO, JSON.stringify(lista));
      }catch(e){
        console.error('Erro ao salvar arquivo', e);
      }
    }

    function carregarHistoricoArquivos(){
      try{
        const raw = localStorage.getItem(LS_KEY_HIST_ARQUIVO);
        let arr = raw ? JSON.parse(raw) : [];
        if (!Array.isArray(arr)) arr = [];
        // sem histórico fictício
        return arr;
      }catch(e){
        console.error('Erro ao carregar histórico', e);
        return [];
      }
    }

    function salvarHistoricoArquivos(lista){
      try{
        localStorage.setItem(LS_KEY_HIST_ARQUIVO, JSON.stringify(lista));
      }catch(e){
        console.error('Erro ao salvar histórico', e);
      }
    }

    // ------- PREENCHER FILTROS (ANO / ESCOLA / ARQUIVO) COM DADOS REAIS -------

    function preencherFiltrosAnoEscola(){
      const selectAnoFiltro  = document.getElementById('filtroAno');
      const selectEscola     = document.getElementById('filtroEscola');
      const selectArquivoAno = document.getElementById('arquivoAno');

      const anosSet = new Set();
      const escolasSet = new Set();

      [...financeiroAlunos, ...arquivoAlunos].forEach(reg => {
        const ano = reg.anoFormatura != null ? String(reg.anoFormatura).trim() : '';
        if (ano) anosSet.add(ano);
        const esc = (reg.escolaNome || '').trim();
        if (esc) escolasSet.add(esc);
      });

      const anos = Array.from(anosSet).sort();
      const escolas = Array.from(escolasSet).sort((a,b) => a.localeCompare(b, 'pt-BR'));

      // filtro topo: Ano
      if (selectAnoFiltro){
        const valorAtual = selectAnoFiltro.value;
        selectAnoFiltro.innerHTML =
          '<option value="">Todos</option>' +
          anos.map(a => `<option value="${a}">${a}</option>`).join('');
        if (valorAtual && anosSet.has(valorAtual)){
          selectAnoFiltro.value = valorAtual;
        }
      }

      // filtro topo: Escola
      if (selectEscola){
        const valorAtual = selectEscola.value;
        selectEscola.innerHTML =
          '<option value="">Todas</option>' +
          escolas.map(e => `<option value="${e}">${e}</option>`).join('');
        if (valorAtual && escolasSet.has(valorAtual)){
          selectEscola.value = valorAtual;
        }
      }

      // select do painel Arquivo (somente anos)
      if (selectArquivoAno){
        const valorAtual = selectArquivoAno.value;
        selectArquivoAno.innerHTML =
          anos.map(a => `<option value="${a}">${a}</option>`).join('');
        if (valorAtual && anosSet.has(valorAtual)){
          selectArquivoAno.value = valorAtual;
        } else if (!selectArquivoAno.value && anos.length){
          // se não tinha nada selecionado, pega o primeiro ano da lista
          selectArquivoAno.value = anos[0];
        }
      }
    }

    // ------- WHATSAPP -------

    function abrirWhatsapp(numeroRaw, mensagem){
      const texto = mensagem || '';
      const soDigitos = (numeroRaw || '').toString().replace(/\D/g,'');
      if (!soDigitos){
        alert('Não há telefone cadastrado para este responsável.');
        return;
      }

      let numero = soDigitos;
      if (numero.length === 11){
        numero = '55' + numero; // Brasil
      }else if (numero.length === 13 && numero.startsWith('55')){
        numero = soDigitos;
      }

      const url = 'https://wa.me/' + numero + '?text=' + encodeURIComponent(texto);
      window.open(url, '_blank');
    }

    // ------- RENDER INADIMPLENTES -------

    function aplicarFiltrosInadimplentes(){
      const ano      = document.getElementById('filtroAno')?.value || '';
      const escola   = document.getElementById('filtroEscola')?.value || '';
      const situacao = document.getElementById('filtroSituacao')?.value || '';

      listaInadimplentesFiltrada = financeiroAlunos.filter(reg => {
        if (reg.statusFinanceiro === 'quitado') return false; // só inadimplentes aqui

        if (ano && reg.anoFormatura !== ano) return false;
        if (escola && reg.escolaNome !== escola) return false;
        if (situacao && reg.statusFinanceiro !== situacao) return false;

        return true;
      });

      // ordenar por ano, escola, nome
      listaInadimplentesFiltrada.sort((a,b) => {
        if (a.anoFormatura !== b.anoFormatura){
          return (a.anoFormatura || '').localeCompare(b.anoFormatura || '');
        }
        if (a.escolaNome !== b.escolaNome){
          return (a.escolaNome || '').localeCompare(b.escolaNome || '');
        }
        return (a.nomeAluno || '').localeCompare(b.nomeAluno || '');
      });

      renderInadimplentes();
    }

    function renderInadimplentes(){
      const tbody = document.getElementById('tbodyInadimplentes');
      const infoResumo = document.getElementById('infoResumoInadimplentes');
      const lblTotalAberto = document.getElementById('lblTotalAbertoInadimplentes');
      const lblQtdInad = document.getElementById('lblQtdInadimplentes');

      if (!tbody) return;

      if (!listaInadimplentesFiltrada.length){
        tbody.innerHTML = '<tr><td colspan="9">Nenhum aluno inadimplente encontrado com os filtros atuais.</td></tr>';
        if (infoResumo) infoResumo.textContent = 'Exibindo 0 alunos inadimplentes.';
        if (lblTotalAberto) lblTotalAberto.textContent = 'R$ 0,00';
        if (lblQtdInad) lblQtdInad.textContent = '0 alunos';
        if (window.lucide) window.lucide.createIcons();
        return;
      }

      tbody.innerHTML = '';
      let totalAberto = 0;

      listaInadimplentesFiltrada.forEach(reg => {
        totalAberto += Number(reg.valorAberto || 0);

        let clsStatus = 'status-aberto';
        let textoStatus = 'Em aberto';
        let iconStatus = 'clock-3';

        if (reg.statusFinanceiro === 'atraso'){
          clsStatus = 'status-atraso';
          textoStatus = 'Em atraso';
          iconStatus = 'alert-triangle';
        }else if (reg.statusFinanceiro === 'acordo'){
          clsStatus = 'status-acordo';
          textoStatus = 'Em acordo';
          iconStatus = 'file-pen-line';
        }

        const eventosHtml = (reg.eventos || []).map(ev => `<span class="tag-evento">${ev}</span>`).join(' ');

        // ações por situação
        let acoesHtml = `
          <button type="button" class="btn-acao-mini" data-acao="ver-aluno" data-id="${reg.id}">
            <i data-lucide="user-round"></i> Ver aluno
          </button>
        `;

        if (reg.statusFinanceiro === 'atraso'){
          acoesHtml += `
            <button type="button" class="btn-acao-mini" data-acao="cobrar-whats" data-id="${reg.id}">
              <i data-lucide="message-circle"></i> Cobrar WhatsApp
            </button>
            <button type="button" class="btn-acao-mini" data-acao="enviar-cobranca" data-id="${reg.id}">
              <i data-lucide="send"></i> Enviar cobrança
            </button>
          `;
        }else if (reg.statusFinanceiro === 'aberto'){
          acoesHtml += `
            <button type="button" class="btn-acao-mini" data-acao="enviar-cobranca" data-id="${reg.id}">
              <i data-lucide="send"></i> Enviar cobrança
            </button>
          `;
        }else if (reg.statusFinanceiro === 'acordo'){
          acoesHtml += `
            <button type="button" class="btn-acao-mini" data-acao="lembrar-parcela" data-id="${reg.id}">
              <i data-lucide="bell"></i> Lembrar parcela
            </button>
          `;
        }

        // botão Excluir (sempre disponível na lista de inadimplentes)
        acoesHtml += `
          <button type="button" class="btn-acao-mini" data-acao="excluir" data-id="${reg.id}">
            <i data-lucide="trash-2"></i> Excluir
          </button>
        `;

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${reg.nomeAluno || '-'}</td>
          <td>${reg.escolaNome || '-'} – ${reg.anoFormatura || '-'}</td>
          <td>${eventosHtml}</td>
          <td>R$ ${formatarValorBR(reg.valorTotal)}</td>
          <td>R$ ${formatarValorBR(reg.valorPago)}</td>
          <td>R$ ${formatarValorBR(reg.valorAberto)}</td>
          <td>
            <span class="status-financeiro ${clsStatus}">
              <i data-lucide="${iconStatus}"></i> ${textoStatus}
            </span>
          </td>
          <td>${formatarDataBR(reg.ultimoVencimentoISO)}</td>
          <td>
            <div class="acoes-multiplas">
              ${acoesHtml}
            </div>
          </td>
        `;
        tbody.appendChild(tr);
      });

      if (infoResumo){
        const qtd = listaInadimplentesFiltrada.length;
        infoResumo.textContent = `Exibindo ${qtd} aluno${qtd === 1 ? '' : 's'} inadimplente${qtd === 1 ? '' : 's'}.`;
      }
      if (lblTotalAberto){
        lblTotalAberto.textContent = 'R$ ' + formatarValorBR(totalAberto);
      }
      if (lblQtdInad){
        const qtd = listaInadimplentesFiltrada.length;
        lblQtdInad.textContent = `${qtd} aluno${qtd === 1 ? '' : 's'}`;
      }

      if (window.lucide) window.lucide.createIcons();
    }

    // ------- RENDER ARQUIVADOS -------

    function aplicarFiltrosArquivados(){
      const ano    = document.getElementById('filtroAno')?.value || '';
      const escola = document.getElementById('filtroEscola')?.value || '';

      listaArquivadosFiltrada = arquivoAlunos.filter(reg => {
        if (ano && reg.anoFormatura !== ano) return false;
        if (escola && reg.escolaNome !== escola) return false;
        return true;
      });

      listaArquivadosFiltrada.sort((a,b) => {
        if (a.anoFormatura !== b.anoFormatura){
          return (a.anoFormatura || '').localeCompare(b.anoFormatura || '');
        }
        if (a.escolaNome !== b.escolaNome){
          return (a.escolaNome || '').localeCompare(b.escolaNome || '');
        }
        return (a.nomeAluno || '').localeCompare(b.nomeAluno || '');
      });

      renderArquivados();
    }

    function renderArquivados(){
      const tbody = document.getElementById('tbodyArquivados');
      const infoResumo = document.getElementById('infoResumoArquivados');

      if (!tbody) return;

      if (!listaArquivadosFiltrada.length){
        tbody.innerHTML = '<tr><td colspan="6">Nenhum aluno arquivado encontrado com os filtros atuais.</td></tr>';
        if (infoResumo) infoResumo.textContent = 'Exibindo 0 alunos arquivados.';
        if (window.lucide) window.lucide.createIcons();
        return;
      }

      tbody.innerHTML = '';

      listaArquivadosFiltrada.forEach(reg => {
        const eventosHtml = (reg.eventos || []).map(ev => `<span class="tag-evento">${ev}</span>`).join(' ');

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${reg.nomeAluno || '-'}</td>
          <td>${reg.escolaNome || '-'} – ${reg.anoFormatura || '-'}</td>
          <td>${eventosHtml}</td>
          <td>R$ ${formatarValorBR(reg.valorPago)}</td>
          <td>${formatarDataBR(reg.arquivadoEm)}</td>
          <td>
            <button type="button" class="btn-acao-mini" data-acao="ver-aluno" data-id="${reg.id}">
              <i data-lucide="user-round"></i> Ver aluno
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      if (infoResumo){
        const qtd = listaArquivadosFiltrada.length;
        infoResumo.textContent = `Exibindo ${qtd} aluno${qtd === 1 ? '' : 's'} arquivado${qtd === 1 ? '' : 's'}.`;
      }

      if (window.lucide) window.lucide.createIcons();
    }

    // ------- HISTÓRICO DE ARQUIVAMENTOS -------

    function renderHistoricoArquivos(){
      const tbody = document.getElementById('tbodyHistoricoArquivo');
      if (!tbody) return;

      if (!historicoArquivos.length){
        tbody.innerHTML = '<tr><td colspan="4">Nenhum arquivamento registrado ainda.</td></tr>';
        return;
      }

      const lista = historicoArquivos.slice().sort((a,b) => {
        return (b.dataISO || '').localeCompare(a.dataISO || '');
      });

      tbody.innerHTML = '';
      lista.forEach(item => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${item.ano || '-'}</td>
          <td>${formatarDataBR(item.dataISO)}</td>
          <td>${item.qtQuitados ?? '-'}</td>
          <td>${item.qtInadimplentes ?? '-'}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // ------- RESUMO DO ANO (PAINEL DIREITA) -------

    function atualizarResumoAno(){
      const selectAno = document.getElementById('arquivoAno');
      const ano = selectAno?.value || '';

      const lblTotal = document.getElementById('lblAnoTotalAlunos');
      const lblQuit  = document.getElementById('lblAnoQuitados');
      const lblInad  = document.getElementById('lblAnoInadimplentes');

      if (!lblTotal || !lblQuit || !lblInad){
        return;
      }

      if (!ano){
        lblTotal.textContent = '0';
        lblQuit.textContent  = '0';
        lblInad.textContent  = '0';
        return;
      }

      // união de ativo + arquivado
      const todosAno = [
        ...financeiroAlunos.filter(r => r.anoFormatura === ano),
        ...arquivoAlunos.filter(r => r.anoFormatura === ano)
      ];

      const total = todosAno.length;
      const quitados = todosAno.filter(r => r.statusFinanceiro === 'quitado').length;
      const inad = total - quitados;

      lblTotal.textContent = total.toString();
      lblQuit.textContent  = quitados.toString();
      lblInad.textContent  = inad.toString();
    }

    // ------- ARQUIVAR ANO -------

    function arquivarAnoSelecionado(){
      const selectAno = document.getElementById('arquivoAno');
      const ano = selectAno?.value || '';
      if (!ano){
        alert('Selecione um ano para arquivar.');
        return;
      }

      const quitadosAno = financeiroAlunos.filter(
        r => r.anoFormatura === ano && r.statusFinanceiro === 'quitado'
      );
      if (!quitadosAno.length){
        alert(`Não há alunos quitados para o ano ${ano} na base atual.`);
        return;
      }

      const confirmar = confirm(
        `Confirmar arquivamento do ano ${ano}?\n\n` +
        `• ${quitadosAno.length} aluno(s) quitado(s) serão movidos para o arquivo.\n` +
        `• Inadimplentes de ${ano} continuarão visíveis na lista de Inadimplentes.`
      );
      if (!confirmar) return;

      const agoraIso = new Date().toISOString();

      // adiciona ao arquivo
      quitadosAno.forEach(reg => {
        arquivoAlunos.push({
          ...reg,
          arquivadoEm: agoraIso
        });
      });

      // remove esses quitados da base financeira
      financeiroAlunos = financeiroAlunos.filter(
        r => !(r.anoFormatura === ano && r.statusFinanceiro === 'quitado')
      );

      salvarFinanceiro(financeiroAlunos);
      salvarArquivo(arquivoAlunos);

      // registra no histórico
      const totalInadAno = financeiroAlunos.filter(
        r => r.anoFormatura === ano && r.statusFinanceiro !== 'quitado'
      ).length;
      historicoArquivos.push({
        id: criarId('hist_'),
        ano,
        dataISO: agoraIso,
        qtQuitados: quitadosAno.length,
        qtInadimplentes: totalInadAno
      });
      salvarHistoricoArquivos(historicoArquivos);

      // atualiza filtros + telas
      preencherFiltrosAnoEscola();
      atualizarResumoAno();
      aplicarFiltrosInadimplentes();
      aplicarFiltrosArquivados();
      renderHistoricoArquivos();

      alert(`Ano ${ano} arquivado com sucesso. Alunos quitados foram movidos para o arquivo.`);
    }

    // ------- EXPORTAR CSV -------

    function exportarInadimplentesCsv(){
      if (!listaInadimplentesFiltrada.length){
        alert('Não há inadimplentes para exportar com os filtros atuais.');
        return;
      }

      const header = [
        'Aluno',
        'Escola',
        'Ano',
        'Eventos',
        'Valor Total',
        'Valor Pago',
        'Valor Aberto',
        'Situação',
        'Último Vencimento'
      ];

      const linhas = listaInadimplentesFiltrada.map(reg => {
        const eventos = (reg.eventos || []).join(' / ');
        let situacao = reg.statusFinanceiro || '';
        if (situacao === 'atraso') situacao = 'Em atraso';
        if (situacao === 'aberto') situacao = 'Em aberto';
        if (situacao === 'acordo') situacao = 'Em acordo';

        return [
          reg.nomeAluno || '',
          reg.escolaNome || '',
          reg.anoFormatura || '',
          eventos,
          formatarValorBR(reg.valorTotal),
          formatarValorBR(reg.valorPago),
          formatarValorBR(reg.valorAberto),
          situacao,
          formatarDataBR(reg.ultimoVencimentoISO)
        ].join(';');
      });

      const csv = header.join(';') + '\n' + linhas.join('\n');
      const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const ano = document.getElementById('filtroAno')?.value || 'todos';

      a.href = url;
      a.download = `inadimplentes-${ano}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // ------- TABS -------

    function configurarAbas(){
      const botoes = document.querySelectorAll('.aba-botao');
      const abaInad = document.getElementById('abaInadimplentes');
      const abaArq  = document.getElementById('abaArquivados');

      botoes.forEach(btn => {
        btn.addEventListener('click', () => {
          botoes.forEach(b => b.classList.remove('ativa'));
          btn.classList.add('ativa');

          const alvo = btn.getAttribute('data-aba');
          if (alvo === 'inadimplentes'){
            if (abaInad) abaInad.hidden = false;
            if (abaArq)  abaArq.hidden  = true;
          }else{
            if (abaInad) abaInad.hidden = true;
            if (abaArq)  abaArq.hidden  = false;
            // garante que arquivados seja renderizado com filtros atuais
            aplicarFiltrosArquivados();
          }
        });
      });
    }

    // ------- LISTENERS TABELAS -------

    function onCliqueInadimplentes(ev){
      const btn = ev.target.closest('button[data-acao]');
      if (!btn) return;

      const acao = btn.getAttribute('data-acao');
      const id   = btn.getAttribute('data-id');
      const reg  = financeiroAlunos.find(r => r.id === id);
      if (!reg) return;

      if (acao === 'ver-aluno'){
        const alunoId = reg.alunoId || '';
        const url = alunoId
          ? `kgb-formaturas-aluno-detalhe.html?alunoId=${encodeURIComponent(alunoId)}`
          : `kgb-formaturas-aluno-detalhe.html?nome=${encodeURIComponent(reg.nomeAluno || '')}`;
        window.location.href = url;
      }

      if (acao === 'cobrar-whats'){
        const msg =
          `Olá, aqui é da KGB FORMATURAS.\n\n` +
          `Identificamos pendências no contrato de formatura do(a) ${reg.nomeAluno} (${reg.escolaNome} – ${reg.anoFormatura}).\n` +
          `Valor em aberto: R$ ${formatarValorBR(reg.valorAberto)}.\n\n` +
          `Podemos falar sobre a regularização?`;
        abrirWhatsapp(reg.whatsappResponsavel, msg);
      }

      if (acao === 'enviar-cobranca'){
        const msg =
          `Olá! Enviamos este lembrete de pagamento da formatura do(a) ${reg.nomeAluno}.\n\n` +
          `Valor em aberto: R$ ${formatarValorBR(reg.valorAberto)}.\n` +
          `Último vencimento registrado: ${formatarDataBR(reg.ultimoVencimentoISO)}.\n\n` +
          `Qualquer dúvida estamos à disposição.`;
        abrirWhatsapp(reg.whatsappResponsavel, msg);
      }

      if (acao === 'lembrar-parcela'){
        const msg =
          `Olá! Este é um lembrete amigável da parcela do acordo da formatura do(a) ${reg.nomeAluno}.\n\n` +
          `Valor ainda em aberto: R$ ${formatarValorBR(reg.valorAberto)}.\n\n` +
          `Se precisar ajustar datas ou valores, fale com a equipe da KGB FORMATURAS.`;
        abrirWhatsapp(reg.whatsappResponsavel, msg);
      }

      if (acao === 'excluir'){
        const confirmar = confirm(
          'Tem certeza que deseja excluir esse registro financeiro do aluno?\n\n' +
          'Ele deixará de aparecer em todas as telas financeiras.'
        );
        if (!confirmar) return;

        const idx = financeiroAlunos.findIndex(r => r.id === id);
        if (idx >= 0){
          financeiroAlunos.splice(idx, 1);
          salvarFinanceiro(financeiroAlunos);
        }

        // Recalcula filtros, totais e selects com base apenas nos dados reais restantes
        preencherFiltrosAnoEscola();
        aplicarFiltrosInadimplentes();
        aplicarFiltrosArquivados();
        atualizarResumoAno();
      }
    }

    function onCliqueArquivados(ev){
      const btn = ev.target.closest('button[data-acao]');
      if (!btn) return;

      const acao = btn.getAttribute('data-acao');
      const id   = btn.getAttribute('data-id');
      const reg  = arquivoAlunos.find(r => r.id === id);
      if (!reg) return;

      if (acao === 'ver-aluno'){
        const alunoId = reg.alunoId || '';
        const url = alunoId
          ? `kgb-formaturas-aluno-detalhe.html?alunoId=${encodeURIComponent(alunoId)}`
          : `kgb-formaturas-aluno-detalhe.html?nome=${encodeURIComponent(reg.nomeAluno || '')}`;
        window.location.href = url;
      }
    }

    // ------- DOM READY -------

    document.addEventListener('DOMContentLoaded', () => {
      if (window.lucide) window.lucide.createIcons();

      // menu lateral / mobile
      const menu = document.getElementById('menuLateral');
      const btnMenu = document.getElementById('hamburguer');
      const backdrop = document.getElementById('menuBackdrop');

      if (btnMenu && menu && backdrop) {
        const toggleMenu = () => {
          const aberto = menu.classList.toggle('aberto');
          backdrop.hidden = !aberto;
        };
        btnMenu.addEventListener('click', toggleMenu);
        backdrop.addEventListener('click', toggleMenu);
      }

      // carregar dados do sistema (sempre 100% reais do localStorage)
      financeiroAlunos   = carregarFinanceiro();
      arquivoAlunos      = carregarArquivo();
      historicoArquivos  = carregarHistoricoArquivos();

      // montar filtros com base nesses dados
      preencherFiltrosAnoEscola();

      // filtros / botões
      document.getElementById('btnAtualizarLista')?.addEventListener('click', () => {
        // recarrega do localStorage (caso outra tela tenha alterado)
        financeiroAlunos   = carregarFinanceiro();
        arquivoAlunos      = carregarArquivo();
        historicoArquivos  = carregarHistoricoArquivos();
        preencherFiltrosAnoEscola();
        aplicarFiltrosInadimplentes();
        aplicarFiltrosArquivados();
        atualizarResumoAno();
        renderHistoricoArquivos();
      });

      document.getElementById('filtroAno')?.addEventListener('change', () => {
        aplicarFiltrosInadimplentes();
        aplicarFiltrosArquivados();
        atualizarResumoAno();
      });
      document.getElementById('filtroEscola')?.addEventListener('change', () => {
        aplicarFiltrosInadimplentes();
        aplicarFiltrosArquivados();
      });
      document.getElementById('filtroSituacao')?.addEventListener('change', aplicarFiltrosInadimplentes);

      // exportar
      document.getElementById('btnExportarInadimplentes')?.addEventListener('click', exportarInadimplentesCsv);

      // resumo ano / arquivar
      document.getElementById('btnCarregarResumoAno')?.addEventListener('click', atualizarResumoAno);
      document.getElementById('arquivoAno')?.addEventListener('change', atualizarResumoAno);
      document.getElementById('btnArquivarAno')?.addEventListener('click', arquivarAnoSelecionado);

      // tabelas: clique
      document.getElementById('tbodyInadimplentes')?.addEventListener('click', onCliqueInadimplentes);
      document.getElementById('tbodyArquivados')?.addEventListener('click', onCliqueArquivados);

      // abas
      configurarAbas();

      // carga inicial
      aplicarFiltrosInadimplentes();
      aplicarFiltrosArquivados();
      atualizarResumoAno();
      renderHistoricoArquivos();

      if (window.lucide) window.lucide.createIcons();
    });
  </script>
</body>
</html>
