<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KGB FORMATURAS - Relatórios</title>

  <!-- Ícones Lucide -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <!-- Estilos globais do sistema -->
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="menu-lateral.css?v=espresso12">

  <style>
    :root{ --sidebar-w:260px; }

    html, body{
      margin:0; padding:0; background:#f8f1e8; height:100%;
    }

    main.conteudo-principal,
    input, select, textarea, button{
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
    }
    h1, h2, h3{
      font-family:"Playfair Display", ui-serif, Georgia, "Times New Roman", serif;
    }

    .wrapper{
      display:flex;
      min-height:100vh;
      overflow:hidden;
    }

    #menuLateral{
      flex-shrink:0;
      height:100vh;
      overflow-y:auto;
    }

    main.conteudo-principal{
      flex:1;
      min-height:100vh;
      height:auto;
      overflow-y:auto;
      width:100% !important;
      max-width:none !important;
      margin:0 !important;
      padding:24px clamp(16px, 3vw, 32px) 40px;
    }

    .conteudo-central{ display:contents !important; }

    h1{
      font-size:26px;
      color:#5a3e2b;
      display:flex;
      align-items:center;
      gap:10px;
      margin-bottom:4px;
    }
    h1 i{
      width:26px; height:26px;
      color:#c29a5d;
    }
    .subtitulo{
      margin:0 0 18px;
      font-size:14px;
      color:#8a6a4a;
    }

    #hamburguer{
      position:fixed; top:12px; left:12px;
      background:#c29a5d; border:none; color:#fff;
      font-size:24px; padding:6px 12px; border-radius:8px;
      z-index:1001; display:none;
      cursor:pointer;
    }

    @media (min-width:769px){
      #menuLateral{
        position:fixed; inset:0 auto 0 0;
        width:var(--sidebar-w); height:100vh; z-index:999;
      }
      .wrapper{ padding-left:var(--sidebar-w); }
      main.conteudo-principal{ margin-left:0 !important; }
    }

    @media (max-width:768px){
      #hamburguer{ display:block; }

      #menuLateral{
        position:fixed;
        transform:translateX(-100%);
        transition:transform .3s ease;
        z-index:999; width:var(--sidebar-w);
      }
      #menuLateral.aberto{ transform:translateX(0); }

      .wrapper{ padding-left:0; }
      main.conteudo-principal{ padding:20px; }
    }

    html body aside#menuLateral{
      background-color:#532b03 !important;
      background-image:none !important;
      box-shadow:2px 0 14px rgba(0,0,0,.18);
    }
    aside#menuLateral .menu-lateral,
    aside#menuLateral .submenu{
      background:transparent !important;
      background-color:transparent !important;
    }

    /* --------- FILTROS GERAIS --------- */

    .linha-topo-relatorios{
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      flex-wrap:wrap;
      gap:12px;
      margin-bottom:18px;
    }

    .grupo-filtros{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
    }

    .campo{
      display:flex;
      flex-direction:column;
      gap:4px;
      font-size:12px;
      color:#7a5a3c;
    }
    .campo label{
      font-weight:500;
    }
    .campo select,
    .campo input{
      padding:6px 10px;
      border-radius:8px;
      border:1px solid #e1cbb0;
      background:#fff;
      font-size:13px;
      outline:none;
      min-width:140px;
    }
    .campo select:focus,
    .campo input:focus{
      border-color:#c29a5d;
      box-shadow:0 0 0 1px rgba(194,154,93,0.25);
    }

    .btn-primario,
    .btn-secundario{
      border:none;
      border-radius:999px;
      padding:8px 16px;
      font-size:13px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      box-shadow:0 8px 16px rgba(0,0,0,.12);
    }
    .btn-primario{
      background:#c29a5d;
      color:#fff;
    }
    .btn-secundario{
      background:#f5e7d8;
      color:#6c4b30;
    }
    .btn-primario i,
    .btn-secundario i{
      width:16px; height:16px;
    }

    .texto-suporte{
      font-size:11px;
      color:#9a7b58;
      margin-top:4px;
    }

    /* --------- LAYOUT PRINCIPAL --------- */

    .grid-relatorios{
      display:grid;
      grid-template-columns:minmax(0, 0.85fr) minmax(0, 1.5fr);
      gap:18px;
      align-items:flex-start;
      margin-bottom:20px;
    }
    @media (max-width:1000px){
      .grid-relatorios{
        grid-template-columns:1fr;
      }
    }

    .card{
      background:#fff;
      border-radius:14px;
      padding:16px 18px;
      box-shadow:0 8px 20px rgba(0,0,0,.06);
    }
    .card h2{
      font-size:18px;
      margin:0 0 8px;
      color:#5a3e2b;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .card h2 i{
      width:18px; height:18px;
    }

    /* --------- MENU DE RELATÓRIOS --------- */

    .lista-relatorios{
      list-style:none;
      padding:0;
      margin:8px 0 0;
      display:flex;
      flex-direction:column;
      gap:6px;
    }

    .btn-relatorio{
      border:none;
      border-radius:12px;
      padding:8px 10px;
      font-size:13px;
      cursor:pointer;
      background:#f5e7d8;
      color:#6c4b30;
      display:flex;
      align-items:flex-start;
      gap:8px;
      text-align:left;
      width:100%;
    }
    .btn-relatorio i{
      width:16px; height:16px;
      margin-top:2px;
    }
    .btn-relatorio span{
      font-weight:600;
      display:block;
    }
    .btn-relatorio small{
      font-weight:400;
      font-size:11px;
      color:#9a7b58;
      display:block;
      margin-top:2px;
    }
    .btn-relatorio.ativo{
      background:#c29a5d;
      color:#fff;
      box-shadow:0 8px 16px rgba(0,0,0,.15);
    }
    .btn-relatorio.ativo small{
      color:#fbeeda;
    }

    /* --------- CONTEÚDO DE RELATÓRIO --------- */

    .relatorio-conteudo{
      display:none;
    }
    .relatorio-conteudo.ativo{
      display:block;
    }

    .linha-botoes-relatorio{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      margin-bottom:10px;
      flex-wrap:wrap;
    }

    .grupo-botoes-relatorio{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }

    .tabela-simples{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }
    .tabela-simples thead{
      background:#f5e7d8;
    }
    .tabela-simples th,
    .tabela-simples td{
      padding:8px 10px;
      text-align:left;
      vertical-align:middle;
    }
    .tabela-simples th{
      font-weight:600;
      color:#6c4b30;
    }
    .tabela-simples tbody tr:nth-child(even){
      background:#fdf7f0;
    }

    .rodape-tabela{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-top:10px;
      font-size:11px;
      color:#9a7b58;
      flex-wrap:wrap;
      gap:8px;
    }

    .tag-evento{
      display:inline-flex;
      padding:3px 8px;
      border-radius:999px;
      font-size:11px;
      background:#f3e8da;
      color:#6c4b30;
      margin-right:4px;
      margin-bottom:2px;
    }

    .status-financeiro{
      font-size:11px;
      padding:3px 8px;
      border-radius:999px;
      display:inline-flex;
      align-items:center;
      gap:4px;
    }
    .status-financeiro i{
      width:12px; height:12px;
    }
    .status-ok{
      background:#e4f7ec;
      color:#1f6b3b;
    }
    .status-pendente{
      background:#fff8e2;
      color:#7a5a00;
    }
    .status-inadimplente{
      background:#ffe8e5;
      color:#a32222;
    }

    .card-resumo{
      background:#fdf7f0;
      border-radius:10px;
      padding:8px 12px;
      min-width:160px;
      font-size:12px;
      color:#7a5a3c;
      display:inline-block;
      margin-right:8px;
      margin-bottom:6px;
    }
    .card-resumo strong{
      display:block;
      font-size:12px;
      color:#4b2d16;
      margin-bottom:2px;
    }

    .resumos-linha{
      margin:8px 0 4px;
    }

    .badge-pequena{
      font-size:11px;
      padding:2px 6px;
      border-radius:999px;
      background:#f5e7d8;
      color:#6c4b30;
      display:inline-flex;
      align-items:center;
      gap:4px;
    }
    .badge-pequena i{
      width:12px; height:12px;
    }
  </style>
</head>
<body>

  <!-- Botão Mobile -->
  <button id="hamburguer" aria-label="Abrir menu"><i data-lucide="menu"></i></button>

  <div class="wrapper">
    <aside id="menuLateral"></aside>
    <div id="menuBackdrop" hidden></div>

    <main class="conteudo-principal">
      <div class="conteudo-central">

        <h1><i data-lucide="file-bar-chart"></i> Relatórios – KGB FORMATURAS</h1>
        <p class="subtitulo">
          Gere relatórios por evento, escola, aluno e período, além da projeção de recebimentos.
        </p>

        <!-- FILTROS GERAIS -->
        <div class="linha-topo-relatorios">
          <div class="grupo-filtros">
            <div class="campo">
              <label for="filtroAnoRel">Ano da formatura</label>
              <!-- Será preenchido dinamicamente pelo JS com anos reais -->
              <select id="filtroAnoRel"></select>
            </div>
            <div class="campo">
              <label for="filtroPeriodoRel">Período</label>
              <select id="filtroPeriodoRel">
                <option value="ano">Ano inteiro</option>
                <option value="tri1">1º trimestre</option>
                <option value="tri2">2º trimestre</option>
                <option value="tri3">3º trimestre</option>
                <option value="tri4">4º trimestre</option>
              </select>
            </div>
            <div class="campo">
              <label for="filtroEscolaRel">Escola</label>
              <!-- Opção "Todas" fixa, demais escolas virão dos dados reais via JS -->
              <select id="filtroEscolaRel">
                <option value="">Todas</option>
              </select>
            </div>
          </div>

          <button type="button" class="btn-secundario" id="btnAplicarFiltrosRel">
            <i data-lucide="sliders-horizontal"></i>
            Aplicar filtros gerais
          </button>
        </div>

        <!-- GRID PRINCIPAL -->
        <div class="grid-relatorios">

          <!-- MENU LATERAL DE TIPOS DE RELATÓRIO -->
          <aside class="card" aria-label="Tipos de relatório">
            <h2><i data-lucide="list-todo"></i> Tipos de relatório</h2>
            <p class="texto-suporte">
              Escolha qual visão você quer gerar. Os filtros gerais acima se aplicam a todos.
            </p>

            <ul class="lista-relatorios">
              <li>
                <button class="btn-relatorio ativo" data-rel="por-evento">
                  <i data-lucide="party-popper"></i>
                  <div>
                    <span>Por evento</span>
                    <small>Alunos, total vendido, recebido e em aberto por evento.</small>
                  </div>
                </button>
              </li>
              <li>
                <button class="btn-relatorio" data-rel="por-escola">
                  <i data-lucide="school-2"></i>
                  <div>
                    <span>Por escola</span>
                    <small>Alunos com contrato e faturamento por escola.</small>
                  </div>
                </button>
              </li>
              <li>
                <button class="btn-relatorio" data-rel="por-aluno">
                  <i data-lucide="user-round"></i>
                  <div>
                    <span>Por aluno</span>
                    <small>Situação financeira detalhada por aluno.</small>
                  </div>
                </button>
              </li>
              <li>
                <button class="btn-relatorio" data-rel="por-periodo">
                  <i data-lucide="calendar-range"></i>
                  <div>
                    <span>Por período</span>
                    <small>Faturamento por mês e eventos realizados.</small>
                  </div>
                </button>
              </li>
              <li>
                <button class="btn-relatorio" data-rel="projecao">
                  <i data-lucide="trending-up"></i>
                  <div>
                    <span>Projeção de recebimento</span>
                    <small>Entradas futuras com base nas parcelas a vencer.</small>
                  </div>
                </button>
              </li>
            </ul>
          </aside>

          <!-- CONTEÚDOS DOS RELATÓRIOS -->
          <section class="card">

            <!-- RELATÓRIO: POR EVENTO -->
            <div class="relatorio-conteudo ativo" id="rel-por-evento">
              <h2><i data-lucide="party-popper"></i> Relatório por evento</h2>
              <p class="texto-suporte">
                Ideal para saber se um evento “se pagou”.
              </p>

              <div class="linha-botoes-relatorio">
                <div class="grupo-filtros">
                  <div class="campo">
                    <label for="filtroTipoEventoRelEvento">Tipo de evento</label>
                    <!-- Será preenchido com os tipos reais (localStorage tipos de evento) -->
                    <select id="filtroTipoEventoRelEvento">
                      <option value="">Todos</option>
                    </select>
                  </div>
                </div>

                <div class="grupo-botoes-relatorio">
                  <button type="button" class="btn-secundario btnGerarRel" data-rel="por-evento">
                    <i data-lucide="play-circle"></i> Gerar relatório
                  </button>
                  <button type="button" class="btn-secundario btnExportarRel" data-rel="por-evento">
                    <i data-lucide="download"></i> Exportar (Excel/PDF)
                  </button>
                </div>
              </div>

              <div class="resumos-linha">
                <span class="card-resumo">
                  <strong>Total vendido (eventos filtrados)</strong>
                  R$ 0,00
                </span>
                <span class="card-resumo">
                  <strong>Total recebido</strong>
                  R$ 0,00
                </span>
                <span class="card-resumo">
                  <strong>Em aberto / atrasado</strong>
                  R$ 0,00
                </span>
              </div>

              <table class="tabela-simples">
                <thead>
                  <tr>
                    <th>Evento</th>
                    <th>Tipo</th>
                    <th>Data</th>
                    <th>Escolas</th>
                    <th>Alunos</th>
                    <th>Total vendido</th>
                    <th>Recebido</th>
                    <th>Em aberto</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>

              <div class="rodape-tabela">
                <span>Exibindo 0 eventos.</span>
                <span class="badge-pequena">
                  <i data-lucide="info"></i> No futuro, você poderá clicar para abrir detalhes.
                </span>
              </div>
            </div>

            <!-- RELATÓRIO: POR ESCOLA -->
            <div class="relatorio-conteudo" id="rel-por-escola">
              <h2><i data-lucide="school-2"></i> Relatório por escola</h2>
              <p class="texto-suporte">
                Quanto cada escola está gerando de faturamento.
              </p>

              <div class="linha-botoes-relatorio">
                <span class="badge-pequena">
                  <i data-lucide="filter"></i> Usa os filtros gerais acima.
                </span>

                <div class="grupo-botoes-relatorio">
                  <button type="button" class="btn-secundario btnGerarRel" data-rel="por-escola">
                    <i data-lucide="play-circle"></i> Gerar relatório
                  </button>
                  <button type="button" class="btn-secundario btnExportarRel" data-rel="por-escola">
                    <i data-lucide="download"></i> Exportar (Excel/PDF)
                  </button>
                </div>
              </div>

              <div class="resumos-linha">
                <span class="card-resumo">
                  <strong>Alunos com contrato</strong>
                  0
                </span>
                <span class="card-resumo">
                  <strong>Faturamento total</strong>
                  R$ 0,00
                </span>
                <span class="card-resumo">
                  <strong>Inadimplentes</strong>
                  0 alunos
                </span>
              </div>

              <table class="tabela-simples">
                <thead>
                <tr>
                  <th>Escola</th>
                  <th>Alunos com contrato</th>
                  <th>Faturamento</th>
                  <th>Recebido</th>
                  <th>Em aberto</th>
                  <th>Inadimplentes</th>
                </tr>
                </thead>
                <tbody></tbody>
              </table>

              <div class="rodape-tabela">
                <span>Exibindo 0 escolas.</span>
              </div>
            </div>

            <!-- RELATÓRIO: POR ALUNO -->
            <div class="relatorio-conteudo" id="rel-por-aluno">
              <h2><i data-lucide="user-round"></i> Relatório por aluno</h2>
              <p class="texto-suporte">
                Lista de alunos com situação financeira detalhada.
              </p>

              <div class="linha-botoes-relatorio">
                <div class="grupo-filtros">
                  <div class="campo">
                    <label for="filtroSituacaoAluno">Situação financeira</label>
                    <select id="filtroSituacaoAluno">
                      <option value="">Todos</option>
                      <option>Quitado</option>
                      <option>Em aberto</option>
                      <option>Em atraso</option>
                      <option>Inadimplente</option>
                    </select>
                  </div>
                </div>

                <div class="grupo-botoes-relatorio">
                  <button type="button" class="btn-secundario btnGerarRel" data-rel="por-aluno">
                    <i data-lucide="play-circle"></i> Gerar relatório
                  </button>
                  <button type="button" class="btn-secundario btnExportarRel" data-rel="por-aluno">
                    <i data-lucide="download"></i> Exportar (Excel/PDF)
                  </button>
                </div>
              </div>

              <table class="tabela-simples">
                <thead>
                <tr>
                  <th>Aluno</th>
                  <th>Escola / Ano</th>
                  <th>Eventos</th>
                  <th>Total</th>
                  <th>Pago</th>
                  <th>Em aberto</th>
                  <th>Situação</th>
                </tr>
                </thead>
                <tbody></tbody>
              </table>

              <div class="rodape-tabela">
                <span>Exibindo 0 alunos.</span>
              </div>
            </div>

            <!-- RELATÓRIO: POR PERÍODO -->
            <div class="relatorio-conteudo" id="rel-por-periodo">
              <h2><i data-lucide="calendar-range"></i> Relatório por período</h2>
              <p class="texto-suporte">
                Quanto você faturou por mês.
              </p>

              <div class="linha-botoes-relatorio">
                <div class="grupo-filtros">
                  <div class="campo">
                    <label for="filtroPeriodoDetalhe">Detalhamento</label>
                    <select id="filtroPeriodoDetalhe">
                      <option>Mensal</option>
                      <option>Trimestral</option>
                    </select>
                  </div>
                </div>

                <div class="grupo-botoes-relatorio">
                  <button type="button" class="btn-secundario btnGerarRel" data-rel="por-periodo">
                    <i data-lucide="play-circle"></i> Gerar relatório
                  </button>
                  <button type="button" class="btn-secundario btnExportarRel" data-rel="por-periodo">
                    <i data-lucide="download"></i> Exportar (Excel/PDF)
                  </button>
                </div>
              </div>

              <table class="tabela-simples">
                <thead>
                <tr>
                  <th>Mês</th>
                  <th>Eventos</th>
                  <th>Faturamento</th>
                  <th>Recebido</th>
                  <th>Em aberto</th>
                </tr>
                </thead>
                <tbody></tbody>
              </table>

              <div class="rodape-tabela">
                <span>Exibindo 0 meses.</span>
              </div>
            </div>

            <!-- RELATÓRIO: PROJEÇÃO -->
            <div class="relatorio-conteudo" id="rel-projecao">
              <h2><i data-lucide="trending-up"></i> Projeção de recebimento</h2>
              <p class="texto-suporte">
                Projeção de entradas futuras com base nas parcelas a vencer.
              </p>

              <div class="linha-botoes-relatorio">
                <div class="grupo-filtros">
                  <div class="campo">
                    <label for="filtroMesesProjecao">Meses à frente</label>
                    <select id="filtroMesesProjecao">
                      <option value="3">Próximos 3 meses</option>
                      <option value="6" selected>Próximos 6 meses</option>
                      <option value="12">Próximos 12 meses</option>
                    </select>
                  </div>
                </div>

                <div class="grupo-botoes-relatorio">
                  <button type="button" class="btn-secundario btnGerarRel" data-rel="projecao">
                    <i data-lucide="play-circle"></i> Gerar relatório
                  </button>
                  <button type="button" class="btn-secundario btnExportarRel" data-rel="projecao">
                    <i data-lucide="download"></i> Exportar (Excel/PDF)
                  </button>
                </div>
              </div>

              <div class="resumos-linha">
                <span class="card-resumo">
                  <strong>Projeção total</strong>
                  R$ 0,00
                </span>
                <span class="card-resumo">
                  <strong>Mês com maior recebimento previsto</strong>
                  -
                </span>
              </div>

              <table class="tabela-simples">
                <thead>
                <tr>
                  <th>Mês</th>
                  <th>Valor previsto</th>
                  <th>Qtd. parcelas</th>
                  <th>Principal tipo de evento</th>
                </tr>
                </thead>
                <tbody></tbody>
              </table>

              <div class="rodape-tabela">
                <span>Exibindo 0 meses.</span>
              </div>
            </div>

          </section>

        </div>

      </div>
    </main>
  </div>

  <script>
    window.firebaseSync = window.firebaseSync || {};
    window.firebaseSync.enabled = true;
  </script>

  <script type="module" src="menu-lateral.js"></script>

  <!-- Script de proteção, igual ao resto do sistema -->
  <script type="module">
    import guard, { aplicarPermissoesNaTela } from './api/proteger-pagina.js';

    const meta = document.querySelector('meta[name="page-permission"]');
    const permissao = meta?.content?.trim();
    if (permissao) guard({ permissao });

    aplicarPermissoesNaTela();

    try {
      const alvo = document.getElementById('menuLateral');
      if (alvo) {
        const obs = new MutationObserver((muts, o) => {
          if (alvo.firstElementChild) {
            aplicarPermissoesNaTela();
            o.disconnect();
          }
        });
        obs.observe(alvo, { childList: true });
      }
    } catch {}
  </script>

  <!-- SCRIPT PRINCIPAL DOS RELATÓRIOS -->
  <script src="kgb-formaturas-relatorios.js"></script>

</body>
</html>
