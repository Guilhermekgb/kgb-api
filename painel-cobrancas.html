<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta name="page-permission" content="page:painel-cobrancas.html">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- === INÍCIO PATCH __API_BASE__ (auto) === -->
<script>
  (function(){
    var host = String(location.hostname||"").toLowerCase();

    // Produção (Netlify) -> API na Render
    var PROD_API = window.location.origin;

    // Desenvolvimento local
    var DEV_API  = "http://127.0.0.1:3333";

    var base = (/\.netlify\.app$/.test(host)) ? PROD_API
             : (host === "localhost" || host === "127.0.0.1") ? DEV_API
             : PROD_API;

    try { localStorage.setItem("API_BASE", base); } catch(e) {}
    window.__API_BASE__ = base;
    console.log("[KGB] __API_BASE__ =", base);
  })();
</script>
<!-- === FIM PATCH __API_BASE__ (auto) === -->

  <title>Painel de Cobranças Inteligente</title>
  <link rel="icon" href="data:,"><!-- evita 404 do favicon -->

 <!-- Ícones e Chart -->
<script src="https://unpkg.com/lucide@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>


  <!-- Estilos globais -->
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="menu-lateral.css" />

  <style>
    :root{
      --bg:#f8f1e8; --paper:#f5e7d6; --card:#fff; --text:#3a2b23;
      --gold:#c29a5d; --brown:#5a3e2b; --radius:16px; --line:#ead9c8;
      --ok:#16a34a; --warn:#f59e0b; --late:#dc2626; --muted:#6b7280;
    }
    html,body{margin:0;padding:0;background:var(--bg);height:100%;}
    main.conteudo-principal, input, select, button { font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial; }
    h1{ font-family:"Playfair Display", ui-serif, Georgia, serif; font-size:30px; color:var(--brown); display:flex; gap:10px; align-items:center; margin:0 0 16px; }

       .wrapper{
      display:flex;
      min-height:100vh;
      overflow:hidden;
    }

    #menuLateral{
      flex-shrink:0;
      background:var(--brown);
      height:100vh;
      overflow-y:auto;
    }

    :root{
      --bg:#f8f1e8; --paper:#f5e7d6; --card:#fff; --text:#3a2b23;
      --gold:#c29a5d; --brown:#5a3e2b; --radius:16px; --line:#ead9c8;
      --ok:#16a34a; --warn:#f59e0b; --late:#dc2626; --muted:#6b7280;
      --sidebar-w:260px;
    }

    /* Desktop: menu fixo à esquerda */
    @media (min-width:769px){
      #menuLateral{
        position:fixed;
        inset:0 auto 0 0;
        width:var(--sidebar-w);
        z-index:999;
      }
      .wrapper{
        padding-left:var(--sidebar-w);
      }
    }

    /* Mobile: menu escondido + slide com .aberto */
    @media (max-width:768px){
      #menuLateral{
        position:fixed;
        transform:translateX(-100%);
        transition:transform .3s ease;
        z-index:999;
        width:var(--sidebar-w);
      }
      #menuLateral.aberto{
        transform:translateX(0);
      }
      .wrapper{
        padding-left:0;
      }
    }

    main.conteudo-principal{
      flex-grow:1;
      padding:24px;
      min-height:100vh;
      height:auto;
      overflow-y:auto;
    }

    /* Botão hambúrguer */
    #hamburguer{
      position:fixed;
      top:12px;
      left:12px;
      background:var(--gold);
      border:none;
      color:#fff;
      font-size:24px;
      padding:6px 12px;
      border-radius:8px;
      z-index:1001;
      display:none;
    }
    @media (max-width:768px){
      #hamburguer{ display:block; }
    }

    .conteudo-central{ max-width:1280px; margin:0 auto; }

    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:end; }
    .row label{ display:flex; flex-direction:column; gap:6px; font-size:12px; color:var(--brown); }
    .row input, .row select{ background:#fff; border:1px solid var(--line); border-radius:12px; padding:8px 10px; min-height:40px; font-size:13px; }
    .btn{ border:1px solid #d9c7aa; background:#fff; color:var(--brown); padding:8px 12px; border-radius:12px; cursor:pointer; font-weight:600; transition:.15s ease; box-shadow:0 1px 0 rgba(0,0,0,.04); font-size:13px; }
    .btn:hover{ background:#fff6e9; transform:translateY(-1px); box-shadow:0 2px 6px rgba(0,0,0,.08); }

    /* 5 colunas para caber o KPI de Tempo médio */
    .kpis{ display:grid; grid-template-columns:repeat(5,minmax(0,1fr)); gap:12px; margin:14px 0; }
    .card{ background:var(--card); border:1px solid var(--line); border-radius:16px; box-shadow:0 2px 10px rgba(0,0,0,.06); padding:14px; }
    .kpi h3{ margin:0 0 6px; font-size:12px; color:var(--muted); font-weight:600; letter-spacing:.2px; }
    /* números menores e elegantes */
    .kpi .big{ font-size:19px; font-weight:700; color:var(--brown); line-height:1.05; letter-spacing:.1px; }
    .sub{ font-size:11px; color:var(--muted); margin-top:6px; }

    .grids{ display:grid; grid-template-columns: 1.2fr .8fr; gap:14px; }
    .charts{ display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:14px; }

    /* gráficos estáveis + overlay "sem dados" */
    .chart-wrap{ position:relative; }
    .chart-wrap > canvas{ position:absolute; inset:12px; }
    .chart-empty{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; color:var(--muted); font-size:12px; }

    table{ width:100%; border-collapse:separate; border-spacing:0; }
    thead th{ position:sticky; top:0; background:var(--gold); color:#fff; text-align:left; padding:9px 10px; font-size:12px; }
    tbody td{ padding:9px 10px; border-bottom:1px solid #f0e6d6; font-size:12px; color:#2e261a; }
    tbody tr:nth-child(even){ background:#fbf6ef; }

    .badge{ display:inline-block; padding:3px 8px; border-radius:999px; font-size:11px; font-weight:700; }
    .ok{ background:#ecfdf5; color:#065f46; border:1px solid #bfe8c7; }
    .warn{ background:#fff7ed; color:#92400e; border:1px solid #f0d8b1; }
    .late{ background:#fee2e2; color:#991b1b; border:1px solid #fecaca; }

    .section-head{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin:0 0 10px; }
    .section-head h3{ margin:0; color:var(--brown); font-size:15px; font-weight:700; }

    @media (max-width: 1100px){
      .kpis{ grid-template-columns:repeat(2,minmax(0,1fr)); }
      .grids{ grid-template-columns:1fr; }
      .charts{ grid-template-columns:1fr; }
    }
        /* Backdrop do menu no mobile */
    #menuBackdrop{
      position:fixed;
      inset:0;
     background:rgba(0,0,0,0.35);
      z-index:900;
    }

    /* Travar scroll quando o menu está aberto */
    body.no-scroll{
      overflow:hidden;
    }

  </style>
</head>
<body>
  <button id="hamburguer" aria-label="Abrir menu">
    <i data-lucide="menu"></i>
  </button>

  <div class="wrapper">
    <aside id="menuLateral"></aside>
     <div id="menuBackdrop" hidden></div>

 
    <main class="conteudo-principal">
      <div class="conteudo-central">
        <h1><i data-lucide="pie-chart"></i> Painel de Cobranças</h1>

        <!-- Filtros -->
        <div class="card row" style="justify-content:space-between; gap:16px;">
          <div class="row" style="gap:12px;">
            <label>Período (mês)
              <input id="f-mes" type="month" />
            </label>
            <label>Cliente
              <select id="f-cliente">
                <option value="">Todos</option>
              </select>
            </label>
            <label>Evento
              <select id="f-evento">
                <option value="">Todos</option>
              </select>
            </label>
            <label>Status
              <select id="f-status">
                <option value="todos">Todos</option>
                <option value="pago">Pago/Recebido</option>
                <option value="aberto">Em aberto</option>
                <option value="atraso">Inadimplente</option>
              </select>
            </label>
          </div>
          <div class="row">
            <button id="btnLimpar" class="btn">Limpar filtros</button>
          </div>
        </div>

        <!-- KPIs -->
        <section class="kpis">
          <div class="card kpi"><h3>Total faturado</h3><div class="big" id="kpiFaturado">R$ 0,00</div><div class="sub">Entradas emitidas</div></div>
          <div class="card kpi"><h3>Recebido</h3><div class="big" id="kpiRecebido">R$ 0,00</div><div class="sub">Pagamentos confirmados</div></div>
          <div class="card kpi"><h3>Em aberto</h3><div class="big" id="kpiAberto">R$ 0,00</div><div class="sub">Ainda não pagos</div></div>
          <div class="card kpi"><h3>Inadimplente</h3><div class="big" id="kpiInad">R$ 0,00</div><div class="sub">Vencidos sem pagamento</div></div>
          <div class="card kpi"><h3>Tempo médio</h3><div class="big" id="kpiTempo">—</div><div class="sub">pagos no período</div></div>
        </section>

        <section class="grids">
          <div class="card charts">
            <div class="card chart-wrap" style="height:260px;">
              <canvas id="chartStatus"></canvas>
              <div id="emptyStatus" class="chart-empty" hidden>Sem dados para este filtro.</div>
            </div>
            <div class="card chart-wrap" style="height:260px;">
              <canvas id="chartForma"></canvas>
              <div id="emptyForma" class="chart-empty" hidden>Sem dados recebidos por forma.</div>
            </div>
            <div class="card chart-wrap" style="grid-column:1 / -1; height:280px;">
              <canvas id="chartRecebidosMes"></canvas>
              <div id="emptyRecMes" class="chart-empty" hidden>Sem recebimentos no período.</div>
            </div>
          </div>

          <div class="card">
            <div class="section-head">
              <h3>Top inadimplência (clientes/eventos)</h3>
              <button id="btnCSVInad" class="btn" title="Exportar CSV">Exportar CSV</button>
            </div>
            <div class="table">
              <table>
                <thead>
                  <tr>
                    <th>Cliente</th>
                    <th>Evento</th>
                    <th>Vencidas</th>
                    <th>Total em atraso</th>
                  </tr>
                </thead>
                <tbody id="tbInad"></tbody>
              </table>
            </div>
          </div>
        </section>

        <section class="card" style="margin-top:14px;">
          <div class="section-head">
            <h3>Últimas cobranças</h3>
            <button id="btnCSVUltimos" class="btn" title="Exportar CSV">Exportar CSV</button>
          </div>
          <div class="table">
            <table>
              <thead>
                <tr>
                  <th>Data/Venc.</th>
                  <th>Cliente</th>
                  <th>Evento</th>
                  <th>Descrição</th>
                  <th>Valor</th>
                  <th>Status</th>
                  <th>Forma</th>
                </tr>
              </thead>
              <tbody id="tbUltimos"></tbody>
            </table>
          </div>
        </section>
      </div>
    </main>
  </div>

  <!-- scripts -->
   <!-- scripts -->
  <script type="module" src="menu-lateral.js"></script>
  <script type="module" src="painel-cobrancas.js"></script>
<script>
  (function initHamburguer(){
    const btn   = document.getElementById('hamburguer');
    const aside = document.getElementById('menuLateral');
    const back  = document.getElementById('menuBackdrop');

    if (!btn || !aside || !back) return;

    function setOpened(open){
      const opened = !!open;
      aside.classList.toggle('aberto', opened);
      back.hidden = !opened;
      document.body.classList.toggle('no-scroll', opened);

      const icon = btn.querySelector('i[data-lucide]');
      if (icon){
        icon.setAttribute('data-lucide', opened ? 'x' : 'menu');
        try { window.lucide?.createIcons?.(); } catch(e){}
      }
    }

    function isMobile(){ return window.innerWidth <= 768; }

    function syncVisibility(){
      const mob = isMobile();
      btn.style.display = mob ? 'block' : 'none';
      if (!mob) setOpened(false);
    }

    if (!btn.hasAttribute('data-bound')){
      btn.setAttribute('data-bound','1');
      btn.addEventListener('click', (e)=>{
        e.stopPropagation();
        setOpened(!aside.classList.contains('aberto'));
      });
    }

    if (!back.hasAttribute('data-bound')){
      back.setAttribute('data-bound','1');
      back.addEventListener('click', ()=> setOpened(false));
    }

    document.addEventListener('click', (e)=>{
      if (!aside.classList.contains('aberto')) return;
      if (!aside.contains(e.target) && !btn.contains(e.target)){
        setOpened(false);
      }
    });

    syncVisibility();
    window.addEventListener('resize', syncVisibility);
  })();
</script>



  <script src="/js/auth-helper.js"></script>
  <script src="/api/api-fetch.js"></script>
  <script type="module" src="/api/proteger-pagina.js"></script>
</body>
</html>
